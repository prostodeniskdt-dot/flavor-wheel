// v21.9 dataset — фиксы связей + алиасы + Ром + Бренди/Коньяк
window.CATEGORY_META = [
  {"key":"best","angle":-1.570795,"color":"#2ecc71"},
  {"key":"good","angle":0,"color":"#f1c40f"},
  {"key":"bad","angle":3.14159,"color":"#e74c3c"},
  {"key":"unexpected","angle":1.570795,"color":"#00c2ff"}
];

// Вспомогательная функция для нормализации строк (упрощенная версия canon)
function normalizeString(s){
  if(!s) return "";
  return String(s).normalize('NFKC')
    .replace(/[–—−]/g,'-')
    .replace(/\s*\/\s*/g, '/')
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase()
    .replace(/ё/g,'е');
}

// Функция для автоматического извлечения всех ингредиентов из FLAVOR_DATA
function extractAllIngredients(){
  const allIngredients = new Set();
  const ingredientCategories = new Map(); // Ингредиент -> категория(и), где он упоминается
  
  // Собираем все ингредиенты из FLAVOR_DATA
  if(window.FLAVOR_DATA){
    Object.entries(window.FLAVOR_DATA).forEach(([key, data])=>{
      if(!data) return;
      allIngredients.add(key); // Добавляем сам ключ
      
      // Собираем все ингредиенты из всех категорий
      ['best', 'good', 'bad', 'unexpected'].forEach(catKey => {
        (data[catKey] || []).forEach(item => {
          if(item.to){
            allIngredients.add(item.to);
            // Сохраняем категорию, где упоминается ингредиент
            if(!ingredientCategories.has(item.to)){
              ingredientCategories.set(item.to, new Set());
            }
            ingredientCategories.get(item.to).add(catKey);
          }
        });
      });
    });
  }
  
  return { allIngredients, ingredientCategories };
}

window.TAXONOMY = {
  "categories": ["Фрукты","Овощи","Пряности","Сухие ингредиенты","Травы и зелень","Орехи и семена","Молочные","Крепкие алкогольные напитки"],
  "groups": {
    "Фрукты": ["Цитрусовые","Ягоды","Тропические","Косточковые","Яблоки/Груши","Дыни","Виноград"],
    "Овощи": ["Стеблевые","Крестоцветные","Луковые"],
    "Пряности": ["Корневища"],
    "Сухие ингредиенты": ["Какао/Шоколад","Злаки"],
    "Травы и зелень": ["Свежие травы"],
    "Орехи и семена": ["Орехи","Семена"],
    "Молочные": ["Базовые молочные","Сыры"],
    "Крепкие алкогольные напитки": ["Водка","Текила","Ром","Бренди/Коньяк"]
  },
  "subgroups": {
    "Цитрусовые": ["Лимоны","Лаймы","Апельсины","Грейпфрут","Мандарины"],
    "Ягоды": ["Клубника","Малина","Черника","Смородина чёрная"],
    "Тропические": ["Ананас","Манго","Маракуйя"],
    "Косточковые": ["Вишня","Черешня","Абрикос","Персик","Нектарин","Слива"],
    "Яблоки/Груши": ["Яблоки","Груши"],
    "Дыни": ["Канталупа","Медовая дыня","Арбуз"],
    "Виноград": ["Белый виноград","Красный виноград","Мускат"],

    "Стеблевые": ["Спаржа"],
    "Крестоцветные": ["Брокколи","Цветная капуста","Брюссельская капуста","Капуста белокочанная"],
    "Луковые": ["Лук репчатый","Чеснок","Зелёный лук"],

    "Корневища": ["Имбирь"],

    "Какао/Шоколад": ["Какао"],
    "Злаки": ["Рис","Овёс","Пшеница"],

    "Свежие травы": ["Мята","Базилик","Розмарин","Тимьян","Кинза","Шалфей"],

    "Орехи": ["Миндаль","Фундук","Грецкий орех","Арахис","Фисташка","Кешью"],
    "Семена": ["Кунжут","Тыквенные семечки","Подсолнечные семечки","Льняное семя"],

    "Базовые молочные": ["Сливки","Йогурт","Масло сливочное","Молоко"],
    "Сыры": ["Пармезан","Горгонзола","Бри","Фета"],

    "Водка": ["Чистая","Вкусовая","Ароматическая"],
    "Текила": [
      "100% агавы — Blanco / Plata",
      "100% агавы — Joven / Cristalino",
      "100% агавы — Reposado",
      "100% агавы — Añejo",
      "100% агавы — Extra Añejo",
      "Mixto — Blanco / Silver",
      "Mixto — Joven / Oro",
      "Mixto — Reposado",
      "Mixto — Añejo",
      "Mixto — Extra Añejo"
    ],
    "Ром": [
      "White/Blanco","Gold","Dark","Aged (Añejo)","Spiced","Overproof","Rhum Agricole Blanc","Rhum Agricole Vieux"
    ],
    "Бренди/Коньяк": [
      "Коньяк VS","Коньяк VSOP","Коньяк XO",
      "Арманьяк VS/VSOP","Арманьяк XO",
      "Испанский бренди Reserva","Испанский бренди Gran Reserva",
      "Писко Puro/Acholado/Mosto Verde","Кальвадос"
    ]
  },
  "names": {
    "Лимоны": ["Eureka","Lisbon"],
    "Лаймы": ["Persian (Tahitian)","Key"],
    "Апельсины": ["Navel","Valencia","Blood"],
    "Грейпфрут": ["Ruby Red"],
    "Мандарины": ["Clementine"],

    "Клубника": ["Клубника садовая"],
    "Малина": ["Малина красная"],
    "Черника": ["Черника"],
    "Смородина чёрная": ["Смородина чёрная"],

    "Ананас": ["Ананас"],
    "Манго": ["Манго"],
    "Маракуйя": ["Маракуйя"],

    "Вишня": ["Вишня"],
    "Черешня": ["Черешня"],
    "Абрикос": ["Абрикос"],
    "Персик": ["Персик"],
    "Нектарин": ["Нектарин"],
    "Слива": ["Слива"],

    "Яблоки": ["Granny Smith","Fuji","Golden Delicious"],
    "Груши": ["Конференция","Боск"],

    "Канталупа": ["Канталупа"],
    "Медовая дыня": ["Медовая дыня"],
    "Арбуз": ["Арбуз"],

    "Белый виноград": ["Виноград белый"],
    "Красный виноград": ["Виноград красный"],
    "Мускат": ["Виноград мускатный"],

    "Спаржа": ["Спаржа зелёная"],

    "Брокколи": ["Брокколи"],
    "Цветная капуста": ["Цветная капуста"],
    "Брюссельская капуста": ["Брюссельская капуста"],
    "Капуста белокочанная": ["Капуста белокочанная"],

    "Лук репчатый": ["Лук репчатый"],
    "Чеснок": ["Чеснок"],
    "Зелёный лук": ["Зелёный лук"],

    "Имбирь": ["Имбирь свежий"],

    "Какао": ["Какао порошок"],
    "Рис": ["Рис"],
    "Овёс": ["Овёс"],
    "Пшеница": ["Пшеница"],

    "Мята": ["Мята"],
    "Базилик": ["Базилик"],
    "Розмарин": ["Розмарин"],
    "Тимьян": ["Тимьян"],
    "Кинза": ["Кинза"],
    "Шалфей": ["Шалфей"],

    "Миндаль": ["Миндаль"],
    "Фундук": ["Фундук"],
    "Грецкий орех": ["Грецкий орех"],
    "Арахис": ["Арахис"],
    "Фисташка": ["Фисташка"],
    "Кешью": ["Кешью"],
    "Кунжут": ["Кунжут"],
    "Тыквенные семечки": ["Тыквенные семечки"],
    "Подсолнечные семечки": ["Подсолнечные семечки"],
    "Льняное семя": ["Льняное семя"],

    "Сливки": ["Сливки"],
    "Йогурт": ["Йогурт"],
    "Масло сливочное": ["Масло сливочное"],
    "Молоко": ["Молоко"],
    "Пармезан": ["Пармезан"],
    "Горгонзола": ["Горгонзола"],
    "Бри": ["Бри"],
    "Фета": ["Фета"],

    "Чистая": ["Русский Стандарт Original (40%)","Пять Озёр Классическая","Beluga Noble (40%)"],
    "Вкусовая": ["Absolut Citron","Absolut Raspberry","Finlandia Lime","Finlandia Cranberry"],
    "Ароматическая": ["Пять Озёр Перцовая","Зелёная Марка Перцовая","Тундра Перцовая"],

    "100% агавы — Blanco / Plata": ["Olmeca Altos Plata","Espolòn Blanco","Don Julio Blanco","Patrón Silver","1800 Plata"],
    "100% агавы — Joven / Cristalino": ["Maestro Dobel Diamante (Cristalino)","Jose Cuervo Tradicional Reposado Cristalino","1800 Cristalino","Cazadores Joven Cristalino","Volcán De Mi Tierra Cristalino"],
    "100% агавы — Reposado": ["Espolòn Reposado","Olmeca Altos Reposado","Herradura Reposado","Don Julio Reposado","1800 Reposado"],
    "100% агавы — Añejo": ["1800 Añejo","Don Julio Añejo","Herradura Añejo","Patrón Añejo","Cazadores Añejo"],
    "100% агавы — Extra Añejo": ["Patrón Extra Añejo","Herradura Selección Suprema","1800 Milenio","Don Julio 1942","Gran Patrón Burdeos"],

    "Mixto — Blanco / Silver": ["Olmeca Blanco","Sierra Silver","Jose Cuervo Especial Silver","Sauza Silver","El Jimador Blanco"],
    "Mixto — Joven / Oro": ["Jose Cuervo Especial Gold","Sierra Gold","Sauza Gold","Olmeca Gold","El Jimador Gold"],
    "Mixto — Reposado": ["Olmeca Reposado","Sierra Reposado","Jose Cuervo Especial Reposado","Sauza Reposado","El Jimador Reposado"],
    "Mixto — Añejo": ["Sauza Añejo","Jose Cuervo Añejo","Sierra Añejo","El Jimador Añejo","Olmeca (лимитированные)"],
    "Mixto — Extra Añejo": [],

    "White/Blanco": ["Bacardi Carta Blanca","Havana Club 3","Brugal Especial","Plantation 3 Stars"],
    "Gold": ["Bacardi Carta Oro","Havana Club Añejo Especial","Appleton Estate Signature"],
    "Dark": ["Myers's Dark","Goslings Black Seal","Pusser's"],
    "Aged (Añejo)": ["Diplomatico Reserva Exclusiva","Appleton 12","El Dorado 12"],
    "Spiced": ["Captain Morgan Spiced","Sailor Jerry","Kraken Black Spiced"],
    "Overproof": ["Wray & Nephew Overproof","Plantation OFTD","Lemon Hart 151"],
    "Rhum Agricole Blanc": ["Rhum JM Blanc","Clément Blanc","Damoiseau Blanc"],
    "Rhum Agricole Vieux": ["Rhum JM Vieux","Clément VSOP","Neisson Vieux"],

    "Коньяк VS": ["Hennessy VS","Rémy Martin VS","Camus VS"],
    "Коньяк VSOP": ["Hennessy VSOP","Rémy Martin VSOP","Courvoisier VSOP"],
    "Коньяк XO": ["Hennessy XO","Martell XO","Camus XO"],
    "Арманьяк VS/VSOP": ["Delord VSOP","Janneau VSOP","Larressingle VSOP"],
    "Арманьяк XO": ["Delord XO","Janneau XO","Château de Laubade XO"],
    "Испанский бренди Reserva": ["Torres 10","Cardenal Mendoza Classico","Lepanto Solera Reserva"],
    "Испанский бренди Gran Reserva": ["Torres 15","Cardenal Mendoza Solera Gran Reserva","Lepanto Gran Reserva"],
    "Писко Puro/Acholado/Mosto Verde": ["Barsol Puro","Tabernero Acholado","Waqar Mosto Verde"],
    "Кальвадос": ["Boulard VSOP","Père Magloire VSOP","Château du Breuil VSOP"]
  }
};

window.FLAVOR_DATA = {
  /* ===== ФРУКТЫ (группы) ===== */
  "Цитрусовые": {
    "notes": "Лимонен/цитраль. Любят зелень, крестоцветные, белую рыбу.",
    "best": [
      {"to":"Кинза","tip":"Терпены дружат с зеленью"},
      {"to":"Имбирь","tip":"Цитраль + гингерол"},
      {"to":"Рыба белая","tip":"Кислота чистит жирность"},
      {"to":"Йогурт","tip":"Соусы/десерты"},
      {"to":"Оливковое масло","tip":"Заправки"},
      {"to":"Мята","tip":"Свежесть"}
    ],
    "good": [{"to":"Авокадо","tip":"Кремовость + кислота"},{"to":"Миндаль","tip":"Десертная связка"},{"to":"Чеснок","tip":"Чеснок + цитрус"},{"to":"Мёд","tip":"Баланс"}],
    "bad": [
      {"to":"Сильный дым","tip":"Фенолы забивают цитрус"},
      {"to":"Молоко/Сливки без стабилизации","tip":"Сворачивание"},
      {"to":"Горький хмель","tip":"Биттерность конфликтует"},
      {"to":"Кинин","tip":"Горечь конфликтует"}
    ],
    "unexpected": [{"to":"Тмин","tip":"Пряный сдвиг"},{"to":"Шалфей","tip":"Терпеноидный хвост"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Лимоны": {
    "notes":"Кислотность + цитраль. Яркая кислота и свежесть.",
    "best":[{"to":"Имбирь","tip":"Классика"},{"to":"Йогурт","tip":"Соусы"},{"to":"Оливковое масло","tip":"Заправки"},{"to":"Рыба белая","tip":"Цитрус + рыба"}],
    "good":[{"to":"Кинза","tip":"Зелёный мост"},{"to":"Мёд","tip":"Баланс"},{"to":"Чеснок","tip":"Чеснок + лимон"},{"to":"Авокадо","tip":"Кремовость"}],
    "bad":[{"to":"Сильный дым","tip":"Глушит свежесть"},{"to":"Молоко (много)","tip":"Сворачивание"},{"to":"Кинин","tip":"Горечь конфликтует"}],
    "unexpected":[{"to":"Шалфей","tip":"Терпеноидный хвост"},{"to":"Тмин","tip":"Пряные ноты"}]
  },
  "Лаймы": {
    "notes":"Сильная кислота, лаймовые терпены. Тропическая свежесть.",
    "best":[{"to":"Мята","tip":"Мохито логика"},{"to":"Текила","tip":"Маргарита"},{"to":"Ром","tip":"Тики"},{"to":"Кориандр","tip":"Зелёные ноты"}],
    "good":[{"to":"Огурец","tip":"Фрэш"},{"to":"Имбирь","tip":"Острота"},{"to":"Чили","tip":"Пикантность"},{"to":"Кокос","tip":"Тропики"}],
    "bad":[{"to":"Сильный дым","tip":"Глушит"},{"to":"Молоко (много)","tip":"Сворачивание"},{"to":"Горькие травы (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Кокос","tip":"Тропический мост"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Апельсины": {
    "notes":"Лимонен, сладость. Цитрусовая сладость.",
    "best":[{"to":"Тёмный шоколад","tip":"Классика"},{"to":"Розмарин","tip":"Цедра+хвоя"},{"to":"Мёд","tip":"Сладость"},{"to":"Корица","tip":"Пряность"}],
    "good":[{"to":"Гусиная печень","tip":"Глазури"},{"to":"Миндаль","tip":"Десерты"},{"to":"Ваниль","tip":"Кремы"},{"to":"Тимьян","tip":"Травы"}],
    "bad":[{"to":"Сильный дым","tip":"Гарь"},{"to":"Горький хмель","tip":"Биттерность"},{"to":"Молоко (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Оливки","tip":"Салаты"},{"to":"Бекон","tip":"Солёность"}]
  },
  "Грейпфрут": {
    "notes":"Нарингенин, горчинка. Горьковатая свежесть.",
    "best":[{"to":"Имбирь","tip":"Хайболы"},{"to":"Текила","tip":"Палома"},{"to":"Ром","tip":"Хайболы"},{"to":"Мёд","tip":"Баланс горечи"}],
    "good":[{"to":"Ром белый","tip":"Хайболы"},{"to":"Лайм","tip":"Цитрус"},{"to":"Мята","tip":"Свежесть"},{"to":"Авокадо","tip":"Кремовость"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы усугубляют горечь"},{"to":"Кинин","tip":"Усиливает горечь"},{"to":"Молоко","tip":"Конфликт"}],
    "unexpected":[{"to":"Тмин","tip":"Пряный штрих"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Мандарины": {
    "notes":"Цитрус мягкий, сладкий. Нежная сладость.",
    "best":[{"to":"Белый шоколад","tip":"Десерты"},{"to":"Йогурт","tip":"Соусы"},{"to":"Мёд","tip":"Сладость"},{"to":"Ваниль","tip":"Кремы"}],
    "good":[{"to":"Имбирь","tip":"Фрэш"},{"to":"Миндаль","tip":"Десерты"},{"to":"Корица","tip":"Пряность"},{"to":"Мята","tip":"Свежесть"}],
    "bad":[{"to":"Сильный дым","tip":"Перебивает"},{"to":"Горький хмель","tip":"Конфликт"},{"to":"Кинин","tip":"Горечь"}],
    "unexpected":[{"to":"Шалфей","tip":"Терпеноидный штрих"},{"to":"Розмарин","tip":"Травяные ноты"}]
  },

  "Ягоды": {
    "notes": "Антоцианы. Хорошо с кремом, травами, игристым.",
    "best": [{"to":"Сливки/Йогурт","tip":"Баланс кислоты"},{"to":"Мята","tip":"Свежий верх"},{"to":"Лимон","tip":"Яркость"},{"to":"Мёд","tip":"Сладость"},{"to":"Ваниль","tip":"Классика"}],
    "good": [{"to":"Белый шоколад","tip":"Мягкая жирность"},{"to":"Шоколад","tip":"Десерты"},{"to":"Орехи","tip":"Текстура"},{"to":"Шампанское","tip":"Игристость"}],
    "bad": [
      {"to":"Сильный дым","tip":"Даёт гарь/варенье"},
      {"to":"Кинин без сахара","tip":"Перетягивает"},
      {"to":"Высокие танины","tip":"Сушат"},
      {"to":"Горький хмель","tip":"Конфликт"}
    ],
    "unexpected": [{"to":"Бальзамик","tip":"Кисло-сладкий акцент"},{"to":"Чёрный перец","tip":"Пикантность"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Тропические": {
    "notes": "Эстеры/лактоны. Дружат с ромом/текилой, лаймом.",
    "best": [{"to":"Ром","tip":"Тики база"},{"to":"Лайм","tip":"Баланс"},{"to":"Кокос","tip":"Крем"}],
    "good": [{"to":"Чили","tip":"Пикантность"},{"to":"Имбирь","tip":"Острота"},{"to":"Мята","tip":"Свежесть"}],
    "bad": [
      {"to":"IPA сильно охмелённый","tip":"Горечь гасит эстеры"},
      {"to":"Сильный дым","tip":"Перекрывает фрукт"},
      {"to":"Гвоздика (много)","tip":"Забивает профиль"}
    ],
    "unexpected": [{"to":"Соевый соус","tip":"Умами-глазури"},{"to":"Кардамон","tip":"Пряные ноты"},{"to":"Васаби (микро)","tip":"Острая глубина"}]
  },
  "Косточковые": {
    "notes":"Лактоны персика/абрикоса; в косточке — бензальдегид.",
    "best":[{"to":"Ваниль","tip":"Кремы"},{"to":"Миндаль","tip":"Оржат"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Шампанское","tip":"Беллини-логика"},{"to":"Йогурт","tip":"Крем"},{"to":"Лимонная цедра","tip":"Яркость"}],
    "bad":[
      {"to":"Сильные танины","tip":"Сушат"},
      {"to":"Сильный дым","tip":"Даёт варёную ноту"}
    ],
    "unexpected":[{"to":"Лаванда","tip":"Флоральный штрих"},{"to":"Розмарин","tip":"Травяные ноты"},{"to":"Чёрный чай","tip":"Танины + сладость"}]
  },
  "Яблоки/Груши": {
    "notes":"Яблочная/грушёвая кислота. Специи/карамель — классика.",
    "best":[{"to":"Корица","tip":"Пай/компоты"},{"to":"Карамель","tip":"Тарт Татен"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Свиной бок","tip":"Глазурь"},{"to":"Сидр","tip":"Мост"},{"to":"Орехи","tip":"Текстура"}],
    "bad":[
      {"to":"Сильный дым","tip":"Глушит фрукт"},
      {"to":"Кинин","tip":"Перетягивает сладость"}
    ],
    "unexpected":[{"to":"Чеддер","tip":"Пироги/сэндвичи"},{"to":"Тимьян","tip":"Травяные ноты"},{"to":"Голубой сыр","tip":"Контраст"}]
  },
  "Дыни": {
    "notes":"Деликатный профиль, много воды. Сладость и свежесть.",
    "best":[{"to":"Прошутто","tip":"Классика"},{"to":"Мята","tip":"Фрэш"},{"to":"Лайм","tip":"Яркость"}],
    "good":[{"to":"Фета","tip":"Салаты"},{"to":"Бекон","tip":"Солёность"},{"to":"Моцарелла","tip":"Нежность"}],
    "bad":[
      {"to":"Лук/Чеснок (сырой)","tip":"Перебивают нежный аромат"},
      {"to":"Высокий алкоголь без кислоты","tip":"Жжёт, плоско"}
    ],
    "unexpected":[{"to":"Перец чёрный","tip":"Пикантность"},{"to":"Имбирь","tip":"Острая свежесть"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Виноград": {
    "notes":"Виноградные эфиры/терпены; мускат — флорален.",
    "best":[{"to":"Козий сыр/Бри","tip":"Тарелка"},{"to":"Орехи","tip":"Текстура"},{"to":"Мёд","tip":"Сладость"},{"to":"Инжир","tip":"Классика"}],
    "good":[{"to":"Курица","tip":"Салаты/соусы"},{"to":"Груши","tip":"Фруктовая тарелка"},{"to":"Сыр голубой","tip":"Контраст"},{"to":"Мята","tip":"Свежесть"}],
    "bad":[
      {"to":"Сильный дым","tip":"Перекрывает аромат"},
      {"to":"Перечные настойки без сладости","tip":"Резкость"},
      {"to":"Кинин","tip":"Горечь конфликтует"}
    ],
    "unexpected":[{"to":"Тархун","tip":"Анисовый мост"},{"to":"Розмарин","tip":"Травяные ноты"}]
  },

  /* ===== ОВОЩИ ===== */
  "Стеблевые": {
    "notes":"Стеблевые овощи. Нежная текстура, зелёные ноты.",
    "best":[{"to":"Лимон","tip":"Яркость кислоты"},{"to":"Масло сливочное","tip":"Нежность"}],
    "good":[{"to":"Пармезан","tip":"Соль + умами"},{"to":"Яйцо","tip":"Текстура"}],
    "bad":[{"to":"Сильный дым","tip":"Подчёркивает горечь"}],
    "unexpected":[{"to":"Тархун","tip":"Анисовые ноты"},{"to":"Ваниль","tip":"Неожиданная сладость"}]
  },
  "Крестоцветные": {
    "notes":"Глюкозинолаты (сера). Нужны кислота/жир.",
    "best":[{"to":"Лимоны","tip":"Кислота балансирует"},{"to":"Масло сливочное","tip":"Смягчает"},{"to":"Чеснок","tip":"Классика"},{"to":"Пармезан","tip":"Умами"}],
    "good":[{"to":"Йогурт","tip":"Соусы"},{"to":"Оливковое масло","tip":"Жир"},{"to":"Тимьян","tip":"Травы"},{"to":"Грибы","tip":"Умами"}],
    "bad":[{"to":"Сильный дым","tip":"Усиливает горечь"},{"to":"Шалфей (много)","tip":"Камфора + сера"},{"to":"Кинин","tip":"Горечь конфликтует"}],
    "unexpected":[{"to":"Тахини","tip":"Семенной крем против серы"},{"to":"Арахис","tip":"Ореховые ноты"}]
  },
  "Луковые": {
    "notes":"Сернистые; сладость при карамелизации.",
    "best":[{"to":"Тимьян","tip":"Классика"},{"to":"Масло сливочное","tip":"Конфи"},{"to":"Винный уксус","tip":"Кислота"},{"to":"Пармезан","tip":"Умами"}],
    "good":[{"to":"Бульон","tip":"Луковый суп"},{"to":"Розмарин","tip":"Травы"},{"to":"Грибы","tip":"Умами"},{"to":"Мёд","tip":"Карамелизация"}],
    "bad":[{"to":"Сильный дым","tip":"Дёготь/резкость"},{"to":"Кинин","tip":"Конфликт горечей"},{"to":"Горький хмель","tip":"Биттерность"}],
    "unexpected":[{"to":"Апельсиновая цедра","tip":"Деглазирование"},{"to":"Яблоки","tip":"Сладость"}]
  },

  /* ===== СУХИЕ ===== */
  "Какао/Шоколад": {
    "notes":"Жареный шоколадный профиль. Глубокий и насыщенный.",
    "best":[{"to":"Кофе","tip":"Мокка"},{"to":"Карамель","tip":"Глубина"},{"to":"Ваниль","tip":"Классика"}],
    "good":[{"to":"Орехи","tip":"Фундук/миндаль"},{"to":"Малина","tip":"Кислота"},{"to":"Молоко","tip":"Крем"}],
    "bad":[{"to":"Сильный дым","tip":"Гарь"},{"to":"Цитрус (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Свёкла","tip":"Десерты"},{"to":"Чили","tip":"Острая глубина"},{"to":"Соль","tip":"Карамель"}]
  },
  "Злаки": {
    "notes":"Рис/овёс/пшеница как база. Нейтральность + текстура.",
    "best":[{"to":"Молочные","tip":"Каши/ризотто"},{"to":"Масло сливочное","tip":"Классика"}],
    "good":[{"to":"Свежие травы","tip":"Зелёные акценты"},{"to":"Грибы","tip":"Умами"}],
    "bad":[{"to":"Сильный дым","tip":"Забивает"},{"to":"Кислые фрукты (много)","tip":"Разбавляет"}],
    "unexpected":[{"to":"Кокос","tip":"Тропический ризотто"},{"to":"Карри","tip":"Пряные ноты"}]
  },

  /* ===== ТРАВЫ / ОРЕХИ / СЕМЕНА / СЫРЫ ===== */
  "Свежие травы": {
    "notes":"Летучие терпены. Свежесть и аромат.",
    "best":[{"to":"Цитрусовые","tip":"Мост терпенов"},{"to":"Оливковое масло","tip":"Классика"}],
    "good":[{"to":"Ягоды","tip":"Свежий верх"},{"to":"Помидоры","tip":"Салаты"},{"to":"Огурцы","tip":"Фрэш"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы против терпенов"},{"to":"Кинин","tip":"Бьёт по травам"}],
    "unexpected":[{"to":"Горох","tip":"Весенние супы"},{"to":"Клубника","tip":"Флоральные ноты"},{"to":"Персик","tip":"Свежий акцент"}]
  },
  "Орехи": {
    "notes":"Жареные/маслянистые. Ореховые масла и белки.",
    "best":[{"to":"Шоколад","tip":"Десерты"},{"to":"Сыры","tip":"Текстура"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Фрукты","tip":"Тарелки"},{"to":"Йогурт","tip":"Баланс"}],
    "bad":[{"to":"Сильный дым","tip":"Гарь"},{"to":"Сильно охмелённые напитки","tip":"Горечь перебивает"}],
    "unexpected":[{"to":"Кориандр","tip":"Цитрусовые ноты"},{"to":"Розмарин","tip":"Смоляные штрихи"}]
  },
  "Семена": {
    "notes":"Кунжут/льн/тыква/подсолнечник — семенные масла. Хруст и аромат.",
    "best":[{"to":"Овощи","tip":"Тостовые акценты"},{"to":"Йогурт","tip":"Дипы"}],
    "good":[{"to":"Мёд","tip":"Сладость"},{"to":"Лимон","tip":"Яркость"}],
    "bad":[{"to":"Сильный дым","tip":"Глушит"},{"to":"Горькие травы (много)","tip":"Перебивает"}],
    "unexpected":[{"to":"Мята","tip":"Освежающий акцент"},{"to":"Апельсиновая цедра","tip":"Цитрусовый хруст"}]
  },
  "Сыры": {
    "notes":"От мягких до выдержанных; умами/соль.",
    "best":[{"to":"Груши","tip":"Классика"},{"to":"Виноград","tip":"Тарелки"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Орехи","tip":"Текстура"},{"to":"Инжир","tip":"Сладость"},{"to":"Груши","tip":"Контраст"}],
    "bad":[{"to":"Сильный дым","tip":"Перебивает нюансы"},{"to":"Цитрус (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Карамель","tip":"Соусы"},{"to":"Клубника","tip":"Свежий акцент"},{"to":"Розмарин","tip":"Травяные ноты"}]
  },

  /* ===== МОЛОЧНЫЕ ===== */
  "Базовые молочные": {
    "notes":"Жир/белок смягчают кислоты/горечь.",
    "best":[{"to":"Фрукты","tip":"Десерты"},{"to":"Крестоцветные","tip":"Гратены"},{"to":"Мёд","tip":"Сладость"},{"to":"Ваниль","tip":"Классика"}],
    "good":[{"to":"Свежие травы","tip":"Настои"},{"to":"Орехи","tip":"Текстура"},{"to":"Ягоды","tip":"Десерты"},{"to":"Шоколад","tip":"Крем"}],
    "bad":[{"to":"Свежий ананас","tip":"Бромелайн разрушает белок"},{"to":"Много лимон/лайм без стабилизации","tip":"Сворачивание"},{"to":"Сильный дым","tip":"Конфликт"}],
    "unexpected":[{"to":"Имбирь","tip":"Пана-котта/мороз"},{"to":"Чёрный перец","tip":"Пикантность"}]
  },

  /* ===== ВОДКА ===== */
  "Водка": {
    "notes":"Нейтральный крепкий спирт; платформа для кислоты/сладости/ароматов.",
    "best":[{"to":"Лимон/Лайм","tip":"Sours/Collins/мулы"},{"to":"Имбирь","tip":"Московский мул"},{"to":"Мята","tip":"Свежесть"},{"to":"Огурец","tip":"Фрэш"}],
    "good":[{"to":"Укроп","tip":"Настои"},{"to":"Клюква","tip":"Кисло-сладко"},{"to":"Мёд","tip":"Сладость"},{"to":"Кориандр","tip":"Травы"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы забивают"},{"to":"Кинин без сахара","tip":"Доминирует"},{"to":"Сироп без кислоты","tip":"Плоско"},{"to":"Горький хмель","tip":"Конфликт"}],
    "unexpected":[{"to":"Томатный сок","tip":"Кровавая Мэри"},{"to":"Чёрный перец","tip":"Пикантность"}]
  },
  "Чистая": {
    "notes":"Чистый зерновой профиль.",
    "best":[{"to":"Лимон/Лайм","tip":"Сауры/мулы"},{"to":"Имбирь","tip":"Хайболы"}],
    "good":[{"to":"Огурец/Укроп","tip":"Настои"}],
    "bad":[{"to":"Сильный дым","tip":"Забивает"}],
    "unexpected":[{"to":"Икра","tip":"Классическая подача"}]
  },
  "Вкусовая": {
    "notes":"Цитрус/ягоды и др. Нужен баланс кислоты и сахара.",
    "best":[{"to":"Лайм/Лимон","tip":"Баланс сахара"},{"to":"Мята","tip":"Фрэш"}],
    "good":[{"to":"Газированная вода","tip":"Хайболы"}],
    "bad":[{"to":"Кинин без сахара","tip":"Перетягивает вкус"}],
    "unexpected":[{"to":"Белый шоколад","tip":"Десертные варианты"}]
  },
  "Ароматическая": {
    "notes":"Пряные настойки (перец).",
    "best":[{"to":"Мёд","tip":"Смягчает остроту"},{"to":"Томатный сок","tip":"Bloody Mary"}],
    "good":[{"to":"Чеснок/Укроп","tip":"Закуски"}],
    "bad":[{"to":"Нежные ягоды","tip":"Забивает"},{"to":"Сливки без сахара","tip":"Жгучесть"}],
    "unexpected":[{"to":"Копчёная паприка (микро)","tip":"Глубина"}]
  },

  /* ===== ТЕКИЛА ===== */
  "Текила": {
    "notes":"Агава, минеральность; профиль зависит от выдержки и добавок (mixto).",
    "best":[{"to":"Лайм","tip":"Маргарита/соуэры"},{"to":"Агавовый сироп","tip":"Баланс кислоты"},{"to":"Соль/Чили","tip":"Гарнир/закуска"}],
    "good":[{"to":"Грейпфрут","tip":"Палома"},{"to":"Ананас","tip":"Тропики"},{"to":"Сода","tip":"Хайболы"}],
    "bad":[{"to":"Сильный дым","tip":"Перекрывает терруар"},{"to":"Кинин без сахара","tip":"Горечь бьёт по агаве"},{"to":"Тяжёлая молочка без кислоты","tip":"Плоско/жирно"}],
    "unexpected":[{"to":"Сельдерей","tip":"Минеральный мост"},{"to":"Белый чай","tip":"Чистый верх"}]
  },

  /* ===== РОМ ===== */
  "Ром": {
    "notes":"Эстеры/меласса/тростник; профиль от лёгкого до тяжёлого.",
    "best":[{"to":"Лайм","tip":"Даёт кислоту"},{"to":"Ананас","tip":"Тропики"},{"to":"Кокос","tip":"Крем"},{"to":"Мята","tip":"Мохито"}],
    "good":[{"to":"Имбирь","tip":"Мулы/хайболы"},{"to":"Манго","tip":"Тропики"},{"to":"Чили","tip":"Пикантность"},{"to":"Маракуйя","tip":"Тропическая кислота"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы против эфиров"},{"to":"Высокий кинин","tip":"Жёстко"},{"to":"Горький хмель","tip":"Конфликт"}],
    "unexpected":[{"to":"Кофе","tip":"Тоник/эспрессо-ром"},{"to":"Ваниль","tip":"Сладость"}]
  },

  /* ===== БРЕНДИ / КОНЬЯК ===== */
  "Бренди/Коньяк": {
    "notes":"Виноградные спирты: коньяк/арманьяк/испанский бренди/писко/кальвадос.",
    "best":[{"to":"Шоколад тёмный","tip":"Дайджестив"},{"to":"Орехи","tip":"Текстура"},{"to":"Кофе","tip":"Классика"},{"to":"Ваниль","tip":"Сладость"}],
    "good":[{"to":"Сыр голубой","tip":"Контраст"},{"to":"Яблоко/Груша","tip":"Кальвадос мост"},{"to":"Мёд","tip":"Тёплые ноты"},{"to":"Инжир","tip":"Сладость"}],
    "bad":[{"to":"Сильный дым","tip":"Перекрывает букет"},{"to":"Чистый кинин","tip":"Жёстко"},{"to":"Горький хмель","tip":"Конфликт"}],
    "unexpected":[{"to":"Мёд","tip":"Тёплые сауэры"},{"to":"Имбирь","tip":"Пряные ноты"}]
  }
};

// Автоматически извлекаем все ингредиенты из базы данных и добавляем их в таксономию
(function autoExpandTaxonomy(){
  const { allIngredients, ingredientCategories } = extractAllIngredients();
  
  // Проверяем, что таксономия существует
  if(!window.TAXONOMY){
    window.TAXONOMY = { categories: [], groups: {}, subgroups: {}, names: {} };
  }
  
  // Создаем категорию "Дополнительные ингредиенты" для ингредиентов, которых нет в текущей таксономии
  if(!window.TAXONOMY.categories.includes("Дополнительные ингредиенты")){
    window.TAXONOMY.categories.push("Дополнительные ингредиенты");
    window.TAXONOMY.groups["Дополнительные ингредиенты"] = [];
  }
  
  const existingKeys = new Set();
  // Собираем все существующие ключи из таксономии
  (window.TAXONOMY.categories || []).forEach(cat => existingKeys.add(cat));
  Object.keys(window.TAXONOMY.groups || {}).forEach(g => existingKeys.add(g));
  Object.keys(window.TAXONOMY.subgroups || {}).forEach(sg => existingKeys.add(sg));
  Object.keys(window.TAXONOMY.names || {}).forEach(n => existingKeys.add(n));
  
  // Группируем ингредиенты по типам
  const others = [];
  const drinks = [];
  const foods = [];
  const spices = [];
  
  // Ключевые слова для классификации
  const drinkKeywords = ['алкоголь', 'водка', 'ром', 'текила', 'коньяк', 'бренди', 'сироп', 'сок', 'газированная вода', 'чай', 'кофе'];
  const foodKeywords = ['рыба', 'мясо', 'сыр', 'молоко', 'яйцо', 'гриб', 'бекон', 'прошутто', 'печень', 'курица', 'инжир', 'бульон', 'томатный сок', 'авокадо', 'кокос'];
  const spiceKeywords = ['хмель', 'кинин', 'дым', 'перец', 'уксус', 'бальзамик', 'тахини', 'соус', 'карри', 'паприка', 'васаби', 'кардамон', 'кориандр'];
  
  allIngredients.forEach(ing => {
    const ingCanon = normalizeString(ing);
    
    // Проверяем, есть ли уже в таксономии
    let found = false;
    existingKeys.forEach(key => {
      const keyCanon = normalizeString(key);
      if(keyCanon === ingCanon){
        found = true;
      }
    });
    
    if(!found){
      if(drinkKeywords.some(kw => ingCanon.includes(kw))){
        drinks.push(ing);
      } else if(foodKeywords.some(kw => ingCanon.includes(kw))){
        foods.push(ing);
      } else if(spiceKeywords.some(kw => ingCanon.includes(kw))){
        spices.push(ing);
      } else {
        others.push(ing);
      }
    }
  });
  
  // Добавляем группы и подгруппы
  if(drinks.length > 0){
    const groupName = "Напитки и жидкости";
    if(!window.TAXONOMY.groups["Дополнительные ингредиенты"].includes(groupName)){
      window.TAXONOMY.groups["Дополнительные ингредиенты"].push(groupName);
      window.TAXONOMY.subgroups[groupName] = drinks;
    }
  }
  
  if(foods.length > 0){
    const groupName = "Продукты питания";
    if(!window.TAXONOMY.groups["Дополнительные ингредиенты"].includes(groupName)){
      window.TAXONOMY.groups["Дополнительные ингредиенты"].push(groupName);
      if(!window.TAXONOMY.subgroups[groupName]){
        window.TAXONOMY.subgroups[groupName] = [];
      }
      foods.forEach(f => {
        if(!window.TAXONOMY.subgroups[groupName].includes(f)){
          window.TAXONOMY.subgroups[groupName].push(f);
        }
      });
    }
  }
  
  if(spices.length > 0){
    const groupName = "Пряности и добавки";
    if(!window.TAXONOMY.groups["Дополнительные ингредиенты"].includes(groupName)){
      window.TAXONOMY.groups["Дополнительные ингредиенты"].push(groupName);
      if(!window.TAXONOMY.subgroups[groupName]){
        window.TAXONOMY.subgroups[groupName] = [];
      }
      spices.forEach(s => {
        if(!window.TAXONOMY.subgroups[groupName].includes(s)){
          window.TAXONOMY.subgroups[groupName].push(s);
        }
      });
    }
  }
  
  if(others.length > 0){
    const groupName = "Прочее";
    if(!window.TAXONOMY.groups["Дополнительные ингредиенты"].includes(groupName)){
      window.TAXONOMY.groups["Дополнительные ингредиенты"].push(groupName);
      if(!window.TAXONOMY.subgroups[groupName]){
        window.TAXONOMY.subgroups[groupName] = [];
      }
      others.forEach(o => {
        if(!window.TAXONOMY.subgroups[groupName].includes(o)){
          window.TAXONOMY.subgroups[groupName].push(o);
        }
      });
    }
  }
})();