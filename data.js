// v21.9 dataset — фиксы связей + алиасы + Ром + Бренди/Коньяк
window.CATEGORY_META = [
  {"key":"best","angle":-1.570795,"color":"#2ecc71"},
  {"key":"good","angle":0,"color":"#f1c40f"},
  {"key":"bad","angle":3.14159,"color":"#e74c3c"},
  {"key":"unexpected","angle":1.570795,"color":"#00c2ff"}
];

// Вспомогательная функция для нормализации строк (упрощенная версия canon)
function normalizeString(s){
  if(!s) return "";
  return String(s).normalize('NFKC')
    .replace(/[–—−]/g,'-')
    .replace(/\s*\/\s*/g, '/')
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase()
    .replace(/ё/g,'е');
}

// Функция для автоматического извлечения всех ингредиентов из FLAVOR_DATA
function extractAllIngredients(){
  const allIngredients = new Set();
  const ingredientCategories = new Map(); // Ингредиент -> категория(и), где он упоминается
  
  // Собираем все ингредиенты из FLAVOR_DATA
  if(window.FLAVOR_DATA){
    Object.entries(window.FLAVOR_DATA).forEach(([key, data])=>{
      if(!data) return;
      allIngredients.add(key); // Добавляем сам ключ
      
      // Собираем все ингредиенты из всех категорий
      ['best', 'good', 'bad', 'unexpected'].forEach(catKey => {
        (data[catKey] || []).forEach(item => {
          if(item.to){
            allIngredients.add(item.to);
            // Сохраняем категорию, где упоминается ингредиент
            if(!ingredientCategories.has(item.to)){
              ingredientCategories.set(item.to, new Set());
            }
            ingredientCategories.get(item.to).add(catKey);
          }
        });
      });
    });
  }
  
  return { allIngredients, ingredientCategories };
}

window.TAXONOMY = {
  "categories": ["Фрукты","Овощи","Пряности","Сухие ингредиенты","Травы и зелень","Орехи и семена","Молочные","Крепкие алкогольные напитки"],
  "groups": {
    "Фрукты": ["Цитрусовые","Ягоды","Тропические","Косточковые","Яблоки/Груши","Дыни","Виноград"],
    "Овощи": ["Стеблевые","Крестоцветные","Луковые"],
    "Пряности": ["Корневища"],
    "Сухие ингредиенты": ["Какао/Шоколад","Злаки"],
    "Травы и зелень": ["Свежие травы"],
    "Орехи и семена": ["Орехи","Семена"],
    "Молочные": ["Базовые молочные","Сыры"],
    "Крепкие алкогольные напитки": ["Водка","Текила","Ром","Бренди/Коньяк"]
  },
  "subgroups": {
    "Цитрусовые": ["Лимоны","Лаймы","Апельсины","Грейпфрут","Мандарины"],
    "Ягоды": ["Клубника","Малина","Черника","Смородина чёрная"],
    "Тропические": ["Ананас","Манго","Маракуйя"],
    "Косточковые": ["Вишня","Черешня","Абрикос","Персик","Нектарин","Слива"],
    "Яблоки/Груши": ["Яблоки","Груши"],
    "Дыни": ["Канталупа","Медовая дыня","Арбуз"],
    "Виноград": ["Белый виноград","Красный виноград","Мускат"],

    "Стеблевые": ["Спаржа"],
    "Крестоцветные": ["Брокколи","Цветная капуста","Брюссельская капуста","Капуста белокочанная"],
    "Луковые": ["Лук репчатый","Чеснок","Зелёный лук"],

    "Корневища": ["Имбирь"],

    "Какао/Шоколад": ["Какао"],
    "Злаки": ["Рис","Овёс","Пшеница"],

    "Свежие травы": ["Мята","Базилик","Розмарин","Тимьян","Кинза","Шалфей"],

    "Орехи": ["Миндаль","Фундук","Грецкий орех","Арахис","Фисташка","Кешью"],
    "Семена": ["Кунжут","Тыквенные семечки","Подсолнечные семечки","Льняное семя"],

    "Базовые молочные": ["Сливки","Йогурт","Масло сливочное","Молоко"],
    "Сыры": ["Пармезан","Горгонзола","Бри","Фета"],

    "Водка": ["Чистая","Вкусовая","Ароматическая"],
    "Текила": [
      "100% агавы — Blanco / Plata",
      "100% агавы — Joven / Cristalino",
      "100% агавы — Reposado",
      "100% агавы — Añejo",
      "100% агавы — Extra Añejo",
      "Mixto — Blanco / Silver",
      "Mixto — Joven / Oro",
      "Mixto — Reposado",
      "Mixto — Añejo",
      "Mixto — Extra Añejo"
    ],
    "Ром": [
      "White/Blanco","Gold","Dark","Aged (Añejo)","Spiced","Overproof","Rhum Agricole Blanc","Rhum Agricole Vieux"
    ],
    "Бренди/Коньяк": [
      "Коньяк VS","Коньяк VSOP","Коньяк XO",
      "Арманьяк VS/VSOP","Арманьяк XO",
      "Испанский бренди Reserva","Испанский бренди Gran Reserva",
      "Писко Puro/Acholado/Mosto Verde","Кальвадос"
    ]
  },
  "names": {
    "Лимоны": ["Eureka","Lisbon"],
    "Лаймы": ["Persian (Tahitian)","Key"],
    "Апельсины": ["Navel","Valencia","Blood"],
    "Грейпфрут": ["Ruby Red"],
    "Мандарины": ["Clementine"],

    "Клубника": ["Клубника садовая"],
    "Малина": ["Малина красная"],
    "Черника": ["Черника"],
    "Смородина чёрная": ["Смородина чёрная"],

    "Ананас": ["Ананас"],
    "Манго": ["Манго"],
    "Маракуйя": ["Маракуйя"],

    "Вишня": ["Вишня"],
    "Черешня": ["Черешня"],
    "Абрикос": ["Абрикос"],
    "Персик": ["Персик"],
    "Нектарин": ["Нектарин"],
    "Слива": ["Слива"],

    "Яблоки": ["Granny Smith","Fuji","Golden Delicious"],
    "Груши": ["Конференция","Боск"],

    "Канталупа": ["Канталупа"],
    "Медовая дыня": ["Медовая дыня"],
    "Арбуз": ["Арбуз"],

    "Белый виноград": ["Виноград белый"],
    "Красный виноград": ["Виноград красный"],
    "Мускат": ["Виноград мускатный"],

    "Спаржа": ["Спаржа зелёная"],

    "Брокколи": ["Брокколи"],
    "Цветная капуста": ["Цветная капуста"],
    "Брюссельская капуста": ["Брюссельская капуста"],
    "Капуста белокочанная": ["Капуста белокочанная"],

    "Лук репчатый": ["Лук репчатый"],
    "Чеснок": ["Чеснок"],
    "Зелёный лук": ["Зелёный лук"],

    "Имбирь": ["Имбирь свежий"],

    "Какао": ["Какао порошок"],
    "Рис": ["Рис"],
    "Овёс": ["Овёс"],
    "Пшеница": ["Пшеница"],

    "Мята": ["Мята"],
    "Базилик": ["Базилик"],
    "Розмарин": ["Розмарин"],
    "Тимьян": ["Тимьян"],
    "Кинза": ["Кинза"],
    "Шалфей": ["Шалфей"],

    "Миндаль": ["Миндаль"],
    "Фундук": ["Фундук"],
    "Грецкий орех": ["Грецкий орех"],
    "Арахис": ["Арахис"],
    "Фисташка": ["Фисташка"],
    "Кешью": ["Кешью"],
    "Кунжут": ["Кунжут"],
    "Тыквенные семечки": ["Тыквенные семечки"],
    "Подсолнечные семечки": ["Подсолнечные семечки"],
    "Льняное семя": ["Льняное семя"],

    "Сливки": ["Сливки"],
    "Йогурт": ["Йогурт"],
    "Масло сливочное": ["Масло сливочное"],
    "Молоко": ["Молоко"],
    "Пармезан": ["Пармезан"],
    "Горгонзола": ["Горгонзола"],
    "Бри": ["Бри"],
    "Фета": ["Фета"],

    "Чистая": ["Русский Стандарт Original (40%)","Пять Озёр Классическая","Beluga Noble (40%)"],
    "Вкусовая": ["Absolut Citron","Absolut Raspberry","Finlandia Lime","Finlandia Cranberry"],
    "Ароматическая": ["Пять Озёр Перцовая","Зелёная Марка Перцовая","Тундра Перцовая"],

    "100% агавы — Blanco / Plata": ["Olmeca Altos Plata","Espolòn Blanco","Don Julio Blanco","Patrón Silver","1800 Plata"],
    "100% агавы — Joven / Cristalino": ["Maestro Dobel Diamante (Cristalino)","Jose Cuervo Tradicional Reposado Cristalino","1800 Cristalino","Cazadores Joven Cristalino","Volcán De Mi Tierra Cristalino"],
    "100% агавы — Reposado": ["Espolòn Reposado","Olmeca Altos Reposado","Herradura Reposado","Don Julio Reposado","1800 Reposado"],
    "100% агавы — Añejo": ["1800 Añejo","Don Julio Añejo","Herradura Añejo","Patrón Añejo","Cazadores Añejo"],
    "100% агавы — Extra Añejo": ["Patrón Extra Añejo","Herradura Selección Suprema","1800 Milenio","Don Julio 1942","Gran Patrón Burdeos"],

    "Mixto — Blanco / Silver": ["Olmeca Blanco","Sierra Silver","Jose Cuervo Especial Silver","Sauza Silver","El Jimador Blanco"],
    "Mixto — Joven / Oro": ["Jose Cuervo Especial Gold","Sierra Gold","Sauza Gold","Olmeca Gold","El Jimador Gold"],
    "Mixto — Reposado": ["Olmeca Reposado","Sierra Reposado","Jose Cuervo Especial Reposado","Sauza Reposado","El Jimador Reposado"],
    "Mixto — Añejo": ["Sauza Añejo","Jose Cuervo Añejo","Sierra Añejo","El Jimador Añejo","Olmeca (лимитированные)"],
    "Mixto — Extra Añejo": [],

    "White/Blanco": ["Bacardi Carta Blanca","Havana Club 3","Brugal Especial","Plantation 3 Stars"],
    "Gold": ["Bacardi Carta Oro","Havana Club Añejo Especial","Appleton Estate Signature"],
    "Dark": ["Myers's Dark","Goslings Black Seal","Pusser's"],
    "Aged (Añejo)": ["Diplomatico Reserva Exclusiva","Appleton 12","El Dorado 12"],
    "Spiced": ["Captain Morgan Spiced","Sailor Jerry","Kraken Black Spiced"],
    "Overproof": ["Wray & Nephew Overproof","Plantation OFTD","Lemon Hart 151"],
    "Rhum Agricole Blanc": ["Rhum JM Blanc","Clément Blanc","Damoiseau Blanc"],
    "Rhum Agricole Vieux": ["Rhum JM Vieux","Clément VSOP","Neisson Vieux"],

    "Коньяк VS": ["Hennessy VS","Rémy Martin VS","Camus VS"],
    "Коньяк VSOP": ["Hennessy VSOP","Rémy Martin VSOP","Courvoisier VSOP"],
    "Коньяк XO": ["Hennessy XO","Martell XO","Camus XO"],
    "Арманьяк VS/VSOP": ["Delord VSOP","Janneau VSOP","Larressingle VSOP"],
    "Арманьяк XO": ["Delord XO","Janneau XO","Château de Laubade XO"],
    "Испанский бренди Reserva": ["Torres 10","Cardenal Mendoza Classico","Lepanto Solera Reserva"],
    "Испанский бренди Gran Reserva": ["Torres 15","Cardenal Mendoza Solera Gran Reserva","Lepanto Gran Reserva"],
    "Писко Puro/Acholado/Mosto Verde": ["Barsol Puro","Tabernero Acholado","Waqar Mosto Verde"],
    "Кальвадос": ["Boulard VSOP","Père Magloire VSOP","Château du Breuil VSOP"]
  }
};

window.FLAVOR_DATA = {
  /* ===== ФРУКТЫ (группы) ===== */
  "Цитрусовые": {
    "notes": "Лимонен/цитраль. Любят зелень, крестоцветные, белую рыбу.",
    "best": [
      {"to":"Кинза","tip":"Терпены дружат с зеленью"},
      {"to":"Имбирь","tip":"Цитраль + гингерол"},
      {"to":"Рыба белая","tip":"Кислота чистит жирность"},
      {"to":"Йогурт","tip":"Соусы/десерты"},
      {"to":"Оливковое масло","tip":"Заправки"},
      {"to":"Мята","tip":"Свежесть"}
    ],
    "good": [{"to":"Авокадо","tip":"Кремовость + кислота"},{"to":"Миндаль","tip":"Десертная связка"},{"to":"Чеснок","tip":"Чеснок + цитрус"},{"to":"Мёд","tip":"Баланс"}],
    "bad": [
      {"to":"Сильный дым","tip":"Фенолы забивают цитрус"},
      {"to":"Молоко/Сливки без стабилизации","tip":"Сворачивание"},
      {"to":"Горький хмель","tip":"Биттерность конфликтует"},
      {"to":"Кинин","tip":"Горечь конфликтует"}
    ],
    "unexpected": [{"to":"Тмин","tip":"Пряный сдвиг"},{"to":"Шалфей","tip":"Терпеноидный хвост"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Лимоны": {
    "notes":"Кислотность + цитраль. Яркая кислота и свежесть.",
    "best":[{"to":"Имбирь","tip":"Классика"},{"to":"Йогурт","tip":"Соусы"},{"to":"Оливковое масло","tip":"Заправки"},{"to":"Рыба белая","tip":"Цитрус + рыба"}],
    "good":[{"to":"Кинза","tip":"Зелёный мост"},{"to":"Мёд","tip":"Баланс"},{"to":"Чеснок","tip":"Чеснок + лимон"},{"to":"Авокадо","tip":"Кремовость"}],
    "bad":[{"to":"Сильный дым","tip":"Глушит свежесть"},{"to":"Молоко (много)","tip":"Сворачивание"},{"to":"Кинин","tip":"Горечь конфликтует"}],
    "unexpected":[{"to":"Шалфей","tip":"Терпеноидный хвост"},{"to":"Тмин","tip":"Пряные ноты"}]
  },
  "Лаймы": {
    "notes":"Сильная кислота, лаймовые терпены. Тропическая свежесть.",
    "best":[{"to":"Мята","tip":"Мохито логика"},{"to":"Текила","tip":"Маргарита"},{"to":"Ром","tip":"Тики"},{"to":"Кориандр","tip":"Зелёные ноты"}],
    "good":[{"to":"Огурец","tip":"Фрэш"},{"to":"Имбирь","tip":"Острота"},{"to":"Чили","tip":"Пикантность"},{"to":"Кокос","tip":"Тропики"}],
    "bad":[{"to":"Сильный дым","tip":"Глушит"},{"to":"Молоко (много)","tip":"Сворачивание"},{"to":"Горькие травы (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Кокос","tip":"Тропический мост"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Апельсины": {
    "notes":"Лимонен, сладость. Цитрусовая сладость.",
    "best":[{"to":"Тёмный шоколад","tip":"Классика"},{"to":"Розмарин","tip":"Цедра+хвоя"},{"to":"Мёд","tip":"Сладость"},{"to":"Корица","tip":"Пряность"}],
    "good":[{"to":"Гусиная печень","tip":"Глазури"},{"to":"Миндаль","tip":"Десерты"},{"to":"Ваниль","tip":"Кремы"},{"to":"Тимьян","tip":"Травы"}],
    "bad":[{"to":"Сильный дым","tip":"Гарь"},{"to":"Горький хмель","tip":"Биттерность"},{"to":"Молоко (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Оливки","tip":"Салаты"},{"to":"Бекон","tip":"Солёность"}]
  },
  "Грейпфрут": {
    "notes":"Нарингенин, горчинка. Горьковатая свежесть.",
    "best":[{"to":"Имбирь","tip":"Хайболы"},{"to":"Текила","tip":"Палома"},{"to":"Ром","tip":"Хайболы"},{"to":"Мёд","tip":"Баланс горечи"}],
    "good":[{"to":"Ром белый","tip":"Хайболы"},{"to":"Лайм","tip":"Цитрус"},{"to":"Мята","tip":"Свежесть"},{"to":"Авокадо","tip":"Кремовость"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы усугубляют горечь"},{"to":"Кинин","tip":"Усиливает горечь"},{"to":"Молоко","tip":"Конфликт"}],
    "unexpected":[{"to":"Тмин","tip":"Пряный штрих"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Мандарины": {
    "notes":"Цитрус мягкий, сладкий. Нежная сладость.",
    "best":[{"to":"Белый шоколад","tip":"Десерты"},{"to":"Йогурт","tip":"Соусы"},{"to":"Мёд","tip":"Сладость"},{"to":"Ваниль","tip":"Кремы"}],
    "good":[{"to":"Имбирь","tip":"Фрэш"},{"to":"Миндаль","tip":"Десерты"},{"to":"Корица","tip":"Пряность"},{"to":"Мята","tip":"Свежесть"}],
    "bad":[{"to":"Сильный дым","tip":"Перебивает"},{"to":"Горький хмель","tip":"Конфликт"},{"to":"Кинин","tip":"Горечь"}],
    "unexpected":[{"to":"Шалфей","tip":"Терпеноидный штрих"},{"to":"Розмарин","tip":"Травяные ноты"}]
  },

  "Ягоды": {
    "notes": "Антоцианы. Хорошо с кремом, травами, игристым.",
    "best": [{"to":"Сливки/Йогурт","tip":"Баланс кислоты"},{"to":"Мята","tip":"Свежий верх"},{"to":"Лимон","tip":"Яркость"},{"to":"Мёд","tip":"Сладость"},{"to":"Ваниль","tip":"Классика"}],
    "good": [{"to":"Белый шоколад","tip":"Мягкая жирность"},{"to":"Шоколад","tip":"Десерты"},{"to":"Орехи","tip":"Текстура"},{"to":"Шампанское","tip":"Игристость"}],
    "bad": [
      {"to":"Сильный дым","tip":"Даёт гарь/варенье"},
      {"to":"Кинин без сахара","tip":"Перетягивает"},
      {"to":"Высокие танины","tip":"Сушат"},
      {"to":"Горький хмель","tip":"Конфликт"}
    ],
    "unexpected": [{"to":"Бальзамик","tip":"Кисло-сладкий акцент"},{"to":"Чёрный перец","tip":"Пикантность"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Тропические": {
    "notes": "Эстеры/лактоны. Дружат с ромом/текилой, лаймом.",
    "best": [{"to":"Ром","tip":"Тики база"},{"to":"Лайм","tip":"Баланс"},{"to":"Кокос","tip":"Крем"}],
    "good": [{"to":"Чили","tip":"Пикантность"},{"to":"Имбирь","tip":"Острота"},{"to":"Мята","tip":"Свежесть"}],
    "bad": [
      {"to":"IPA сильно охмелённый","tip":"Горечь гасит эстеры"},
      {"to":"Сильный дым","tip":"Перекрывает фрукт"},
      {"to":"Гвоздика (много)","tip":"Забивает профиль"}
    ],
    "unexpected": [{"to":"Соевый соус","tip":"Умами-глазури"},{"to":"Кардамон","tip":"Пряные ноты"},{"to":"Васаби (микро)","tip":"Острая глубина"}]
  },
  "Косточковые": {
    "notes":"Лактоны персика/абрикоса; в косточке — бензальдегид.",
    "best":[{"to":"Ваниль","tip":"Кремы"},{"to":"Миндаль","tip":"Оржат"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Шампанское","tip":"Беллини-логика"},{"to":"Йогурт","tip":"Крем"},{"to":"Лимонная цедра","tip":"Яркость"}],
    "bad":[
      {"to":"Сильные танины","tip":"Сушат"},
      {"to":"Сильный дым","tip":"Даёт варёную ноту"}
    ],
    "unexpected":[{"to":"Лаванда","tip":"Флоральный штрих"},{"to":"Розмарин","tip":"Травяные ноты"},{"to":"Чёрный чай","tip":"Танины + сладость"}]
  },
  "Яблоки/Груши": {
    "notes":"Яблочная/грушёвая кислота. Специи/карамель — классика.",
    "best":[{"to":"Корица","tip":"Пай/компоты"},{"to":"Карамель","tip":"Тарт Татен"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Свиной бок","tip":"Глазурь"},{"to":"Сидр","tip":"Мост"},{"to":"Орехи","tip":"Текстура"}],
    "bad":[
      {"to":"Сильный дым","tip":"Глушит фрукт"},
      {"to":"Кинин","tip":"Перетягивает сладость"}
    ],
    "unexpected":[{"to":"Чеддер","tip":"Пироги/сэндвичи"},{"to":"Тимьян","tip":"Травяные ноты"},{"to":"Голубой сыр","tip":"Контраст"}]
  },
  "Дыни": {
    "notes":"Деликатный профиль, много воды. Сладость и свежесть.",
    "best":[{"to":"Прошутто","tip":"Классика"},{"to":"Мята","tip":"Фрэш"},{"to":"Лайм","tip":"Яркость"}],
    "good":[{"to":"Фета","tip":"Салаты"},{"to":"Бекон","tip":"Солёность"},{"to":"Моцарелла","tip":"Нежность"}],
    "bad":[
      {"to":"Лук/Чеснок (сырой)","tip":"Перебивают нежный аромат"},
      {"to":"Высокий алкоголь без кислоты","tip":"Жжёт, плоско"}
    ],
    "unexpected":[{"to":"Перец чёрный","tip":"Пикантность"},{"to":"Имбирь","tip":"Острая свежесть"},{"to":"Базилик","tip":"Травяные ноты"}]
  },
  "Виноград": {
    "notes":"Виноградные эфиры/терпены; мускат — флорален.",
    "best":[{"to":"Козий сыр/Бри","tip":"Тарелка"},{"to":"Орехи","tip":"Текстура"},{"to":"Мёд","tip":"Сладость"},{"to":"Инжир","tip":"Классика"}],
    "good":[{"to":"Курица","tip":"Салаты/соусы"},{"to":"Груши","tip":"Фруктовая тарелка"},{"to":"Сыр голубой","tip":"Контраст"},{"to":"Мята","tip":"Свежесть"}],
    "bad":[
      {"to":"Сильный дым","tip":"Перекрывает аромат"},
      {"to":"Перечные настойки без сладости","tip":"Резкость"},
      {"to":"Кинин","tip":"Горечь конфликтует"}
    ],
    "unexpected":[{"to":"Тархун","tip":"Анисовый мост"},{"to":"Розмарин","tip":"Травяные ноты"}]
  },

  /* ===== ОВОЩИ ===== */
  "Стеблевые": {
    "notes":"Стеблевые овощи. Нежная текстура, зелёные ноты.",
    "best":[{"to":"Лимон","tip":"Яркость кислоты"},{"to":"Масло сливочное","tip":"Нежность"}],
    "good":[{"to":"Пармезан","tip":"Соль + умами"},{"to":"Яйцо","tip":"Текстура"}],
    "bad":[{"to":"Сильный дым","tip":"Подчёркивает горечь"}],
    "unexpected":[{"to":"Тархун","tip":"Анисовые ноты"},{"to":"Ваниль","tip":"Неожиданная сладость"}]
  },
  "Крестоцветные": {
    "notes":"Глюкозинолаты (сера). Нужны кислота/жир.",
    "best":[{"to":"Лимоны","tip":"Кислота балансирует"},{"to":"Масло сливочное","tip":"Смягчает"},{"to":"Чеснок","tip":"Классика"},{"to":"Пармезан","tip":"Умами"}],
    "good":[{"to":"Йогурт","tip":"Соусы"},{"to":"Оливковое масло","tip":"Жир"},{"to":"Тимьян","tip":"Травы"},{"to":"Грибы","tip":"Умами"}],
    "bad":[{"to":"Сильный дым","tip":"Усиливает горечь"},{"to":"Шалфей (много)","tip":"Камфора + сера"},{"to":"Кинин","tip":"Горечь конфликтует"}],
    "unexpected":[{"to":"Тахини","tip":"Семенной крем против серы"},{"to":"Арахис","tip":"Ореховые ноты"}]
  },
  "Луковые": {
    "notes":"Сернистые; сладость при карамелизации.",
    "best":[{"to":"Тимьян","tip":"Классика"},{"to":"Масло сливочное","tip":"Конфи"},{"to":"Винный уксус","tip":"Кислота"},{"to":"Пармезан","tip":"Умами"}],
    "good":[{"to":"Бульон","tip":"Луковый суп"},{"to":"Розмарин","tip":"Травы"},{"to":"Грибы","tip":"Умами"},{"to":"Мёд","tip":"Карамелизация"}],
    "bad":[{"to":"Сильный дым","tip":"Дёготь/резкость"},{"to":"Кинин","tip":"Конфликт горечей"},{"to":"Горький хмель","tip":"Биттерность"}],
    "unexpected":[{"to":"Апельсиновая цедра","tip":"Деглазирование"},{"to":"Яблоки","tip":"Сладость"}]
  },

  /* ===== СУХИЕ ===== */
  "Какао/Шоколад": {
    "notes":"Жареный шоколадный профиль. Глубокий и насыщенный.",
    "best":[{"to":"Кофе","tip":"Мокка"},{"to":"Карамель","tip":"Глубина"},{"to":"Ваниль","tip":"Классика"}],
    "good":[{"to":"Орехи","tip":"Фундук/миндаль"},{"to":"Малина","tip":"Кислота"},{"to":"Молоко","tip":"Крем"}],
    "bad":[{"to":"Сильный дым","tip":"Гарь"},{"to":"Цитрус (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Свёкла","tip":"Десерты"},{"to":"Чили","tip":"Острая глубина"},{"to":"Соль","tip":"Карамель"}]
  },
  "Злаки": {
    "notes":"Рис/овёс/пшеница как база. Нейтральность + текстура.",
    "best":[{"to":"Молочные","tip":"Каши/ризотто"},{"to":"Масло сливочное","tip":"Классика"}],
    "good":[{"to":"Свежие травы","tip":"Зелёные акценты"},{"to":"Грибы","tip":"Умами"}],
    "bad":[{"to":"Сильный дым","tip":"Забивает"},{"to":"Кислые фрукты (много)","tip":"Разбавляет"}],
    "unexpected":[{"to":"Кокос","tip":"Тропический ризотто"},{"to":"Карри","tip":"Пряные ноты"}]
  },

  /* ===== ТРАВЫ / ОРЕХИ / СЕМЕНА / СЫРЫ ===== */
  "Свежие травы": {
    "notes":"Летучие терпены. Свежесть и аромат.",
    "best":[{"to":"Цитрусовые","tip":"Мост терпенов"},{"to":"Оливковое масло","tip":"Классика"}],
    "good":[{"to":"Ягоды","tip":"Свежий верх"},{"to":"Помидоры","tip":"Салаты"},{"to":"Огурцы","tip":"Фрэш"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы против терпенов"},{"to":"Кинин","tip":"Бьёт по травам"}],
    "unexpected":[{"to":"Горох","tip":"Весенние супы"},{"to":"Клубника","tip":"Флоральные ноты"},{"to":"Персик","tip":"Свежий акцент"}]
  },
  "Орехи": {
    "notes":"Жареные/маслянистые. Ореховые масла и белки.",
    "best":[{"to":"Шоколад","tip":"Десерты"},{"to":"Сыры","tip":"Текстура"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Фрукты","tip":"Тарелки"},{"to":"Йогурт","tip":"Баланс"}],
    "bad":[{"to":"Сильный дым","tip":"Гарь"},{"to":"Сильно охмелённые напитки","tip":"Горечь перебивает"}],
    "unexpected":[{"to":"Кориандр","tip":"Цитрусовые ноты"},{"to":"Розмарин","tip":"Смоляные штрихи"}]
  },
  "Семена": {
    "notes":"Кунжут/льн/тыква/подсолнечник — семенные масла. Хруст и аромат.",
    "best":[{"to":"Овощи","tip":"Тостовые акценты"},{"to":"Йогурт","tip":"Дипы"}],
    "good":[{"to":"Мёд","tip":"Сладость"},{"to":"Лимон","tip":"Яркость"}],
    "bad":[{"to":"Сильный дым","tip":"Глушит"},{"to":"Горькие травы (много)","tip":"Перебивает"}],
    "unexpected":[{"to":"Мята","tip":"Освежающий акцент"},{"to":"Апельсиновая цедра","tip":"Цитрусовый хруст"}]
  },
  "Сыры": {
    "notes":"От мягких до выдержанных; умами/соль.",
    "best":[{"to":"Груши","tip":"Классика"},{"to":"Виноград","tip":"Тарелки"},{"to":"Мёд","tip":"Сладость"}],
    "good":[{"to":"Орехи","tip":"Текстура"},{"to":"Инжир","tip":"Сладость"},{"to":"Груши","tip":"Контраст"}],
    "bad":[{"to":"Сильный дым","tip":"Перебивает нюансы"},{"to":"Цитрус (много)","tip":"Конфликт"}],
    "unexpected":[{"to":"Карамель","tip":"Соусы"},{"to":"Клубника","tip":"Свежий акцент"},{"to":"Розмарин","tip":"Травяные ноты"}]
  },

  /* ===== МОЛОЧНЫЕ ===== */
  "Базовые молочные": {
    "notes":"Жир/белок смягчают кислоты/горечь.",
    "best":[{"to":"Фрукты","tip":"Десерты"},{"to":"Крестоцветные","tip":"Гратены"},{"to":"Мёд","tip":"Сладость"},{"to":"Ваниль","tip":"Классика"}],
    "good":[{"to":"Свежие травы","tip":"Настои"},{"to":"Орехи","tip":"Текстура"},{"to":"Ягоды","tip":"Десерты"},{"to":"Шоколад","tip":"Крем"}],
    "bad":[{"to":"Свежий ананас","tip":"Бромелайн разрушает белок"},{"to":"Много лимон/лайм без стабилизации","tip":"Сворачивание"},{"to":"Сильный дым","tip":"Конфликт"}],
    "unexpected":[{"to":"Имбирь","tip":"Пана-котта/мороз"},{"to":"Чёрный перец","tip":"Пикантность"}]
  },

  /* ===== ВОДКА ===== */
  "Водка": {
    "notes":"Нейтральный крепкий спирт; платформа для кислоты/сладости/ароматов.",
    "best":[{"to":"Лимон/Лайм","tip":"Sours/Collins/мулы"},{"to":"Имбирь","tip":"Московский мул"},{"to":"Мята","tip":"Свежесть"},{"to":"Огурец","tip":"Фрэш"}],
    "good":[{"to":"Укроп","tip":"Настои"},{"to":"Клюква","tip":"Кисло-сладко"},{"to":"Мёд","tip":"Сладость"},{"to":"Кориандр","tip":"Травы"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы забивают"},{"to":"Кинин без сахара","tip":"Доминирует"},{"to":"Сироп без кислоты","tip":"Плоско"},{"to":"Горький хмель","tip":"Конфликт"}],
    "unexpected":[{"to":"Томатный сок","tip":"Кровавая Мэри"},{"to":"Чёрный перец","tip":"Пикантность"}]
  },
  "Чистая": {
    "notes":"Чистый зерновой профиль.",
    "best":[{"to":"Лимон/Лайм","tip":"Сауры/мулы"},{"to":"Имбирь","tip":"Хайболы"}],
    "good":[{"to":"Огурец/Укроп","tip":"Настои"}],
    "bad":[{"to":"Сильный дым","tip":"Забивает"}],
    "unexpected":[{"to":"Икра","tip":"Классическая подача"}]
  },
  "Вкусовая": {
    "notes":"Цитрус/ягоды и др. Нужен баланс кислоты и сахара.",
    "best":[{"to":"Лайм/Лимон","tip":"Баланс сахара"},{"to":"Мята","tip":"Фрэш"}],
    "good":[{"to":"Газированная вода","tip":"Хайболы"}],
    "bad":[{"to":"Кинин без сахара","tip":"Перетягивает вкус"}],
    "unexpected":[{"to":"Белый шоколад","tip":"Десертные варианты"}]
  },
  "Ароматическая": {
    "notes":"Пряные настойки (перец).",
    "best":[{"to":"Мёд","tip":"Смягчает остроту"},{"to":"Томатный сок","tip":"Bloody Mary"}],
    "good":[{"to":"Чеснок/Укроп","tip":"Закуски"}],
    "bad":[{"to":"Нежные ягоды","tip":"Забивает"},{"to":"Сливки без сахара","tip":"Жгучесть"}],
    "unexpected":[{"to":"Копчёная паприка (микро)","tip":"Глубина"}]
  },

  /* ===== ТЕКИЛА ===== */
  "Текила": {
    "notes":"Агава, минеральность; профиль зависит от выдержки и добавок (mixto).",
    "best":[{"to":"Лайм","tip":"Маргарита/соуэры"},{"to":"Агавовый сироп","tip":"Баланс кислоты"},{"to":"Соль/Чили","tip":"Гарнир/закуска"}],
    "good":[{"to":"Грейпфрут","tip":"Палома"},{"to":"Ананас","tip":"Тропики"},{"to":"Сода","tip":"Хайболы"}],
    "bad":[{"to":"Сильный дым","tip":"Перекрывает терруар"},{"to":"Кинин без сахара","tip":"Горечь бьёт по агаве"},{"to":"Тяжёлая молочка без кислоты","tip":"Плоско/жирно"}],
    "unexpected":[{"to":"Сельдерей","tip":"Минеральный мост"},{"to":"Белый чай","tip":"Чистый верх"}]
  },

  /* ===== РОМ ===== */
  "Ром": {
    "notes":"Эстеры/меласса/тростник; профиль от лёгкого до тяжёлого.",
    "best":[{"to":"Лайм","tip":"Даёт кислоту"},{"to":"Ананас","tip":"Тропики"},{"to":"Кокос","tip":"Крем"},{"to":"Мята","tip":"Мохито"}],
    "good":[{"to":"Имбирь","tip":"Мулы/хайболы"},{"to":"Манго","tip":"Тропики"},{"to":"Чили","tip":"Пикантность"},{"to":"Маракуйя","tip":"Тропическая кислота"}],
    "bad":[{"to":"Сильный дым","tip":"Фенолы против эфиров"},{"to":"Высокий кинин","tip":"Жёстко"},{"to":"Горький хмель","tip":"Конфликт"}],
    "unexpected":[{"to":"Кофе","tip":"Тоник/эспрессо-ром"},{"to":"Ваниль","tip":"Сладость"}]
  },

  /* ===== БРЕНДИ / КОНЬЯК ===== */
  "Бренди/Коньяк": {
    "notes":"Виноградные спирты: коньяк/арманьяк/испанский бренди/писко/кальвадос.",
    "best":[{"to":"Шоколад тёмный","tip":"Дайджестив"},{"to":"Орехи","tip":"Текстура"},{"to":"Кофе","tip":"Классика"},{"to":"Ваниль","tip":"Сладость"}],
    "good":[{"to":"Сыр голубой","tip":"Контраст"},{"to":"Яблоко/Груша","tip":"Кальвадос мост"},{"to":"Мёд","tip":"Тёплые ноты"},{"to":"Инжир","tip":"Сладость"}],
    "bad":[{"to":"Сильный дым","tip":"Перекрывает букет"},{"to":"Чистый кинин","tip":"Жёстко"},{"to":"Горький хмель","tip":"Конфликт"}],
    "unexpected":[{"to":"Мёд","tip":"Тёплые сауэры"},{"to":"Имбирь","tip":"Пряные ноты"}]
  }
};

// Автоматически извлекаем все ингредиенты из базы данных и добавляем их в таксономию
(function autoExpandTaxonomy(){
  const { allIngredients, ingredientCategories } = extractAllIngredients();
  
  // Проверяем, что таксономия существует
  if(!window.TAXONOMY){
    window.TAXONOMY = { categories: [], groups: {}, subgroups: {}, names: {} };
  }
  
  const existingKeys = new Set();
  // Собираем все существующие ключи из таксономии
  (window.TAXONOMY.categories || []).forEach(cat => existingKeys.add(cat));
  Object.keys(window.TAXONOMY.groups || {}).forEach(g => existingKeys.add(g));
  Object.keys(window.TAXONOMY.subgroups || {}).forEach(sg => existingKeys.add(sg));
  Object.keys(window.TAXONOMY.names || {}).forEach(n => existingKeys.add(n));
  // Также добавляем ключи из FLAVOR_DATA
  Object.keys(window.FLAVOR_DATA || {}).forEach(k => existingKeys.add(k));
  
  // Инициализируем структуры для распределения ингредиентов
  const toAdd = {
    'Овощи': { groups: {}, subgroups: {} },
    'Пряности': { groups: {}, subgroups: {} },
    'Сухие ингредиенты': { groups: {}, subgroups: {} },
    'Крепкие алкогольные напитки': { groups: {}, subgroups: {} }
  };
  
  // Специфические сопоставления ингредиентов к категориям
  const ingredientMapping = {
    'Рыба белая': { category: 'Овощи', group: 'Морепродукты', subgroup: 'Рыба' },
    'Сильный дым': { category: 'Пряности', group: 'Добавки и ароматизаторы', subgroup: 'Дым' },
    'Кинин': { category: 'Пряности', group: 'Горькие добавки', subgroup: 'Кинин' },
    'Горький хмель': { category: 'Пряности', group: 'Горькие добавки', subgroup: 'Хмель' },
    'Горькие травы (много)': { category: 'Травы и зелень', group: 'Свежие травы', subgroup: 'Горькие травы' },
    'Кинин без сахара': { category: 'Пряности', group: 'Горькие добавки', subgroup: 'Кинин' },
    'Чистый кинин': { category: 'Пряности', group: 'Горькие добавки', subgroup: 'Кинин' },
    'Высокий кинин': { category: 'Пряности', group: 'Горькие добавки', subgroup: 'Кинин' },
    'Сильно охмелённые напитки': { category: 'Пряности', group: 'Горькие добавки', subgroup: 'Хмель' },
    'Молоко (много)': { category: 'Молочные', group: 'Базовые молочные', subgroup: 'Молоко' },
    'Много лимон/лайм без стабилизации': { category: 'Фрукты', group: 'Цитрусовые', subgroup: 'Цитрусовые' },
    'Цитрус (много)': { category: 'Фрукты', group: 'Цитрусовые', subgroup: 'Цитрусовые' },
    'Кислые фрукты (много)': { category: 'Фрукты', group: 'Ягоды', subgroup: 'Ягоды' },
    'Тяжёлая молочка без кислоты': { category: 'Молочные', group: 'Базовые молочные', subgroup: 'Молочные продукты' },
    'Сироп без кислоты': { category: 'Сухие ингредиенты', group: 'Сладости', subgroup: 'Сиропы' }
  };
  
  allIngredients.forEach(ing => {
    const ingCanon = normalizeString(ing);
    
    // Проверяем, есть ли уже в таксономии
    let found = false;
    existingKeys.forEach(key => {
      const keyCanon = normalizeString(key);
      if(keyCanon === ingCanon){
        found = true;
      }
    });
    
    if(!found){
      // Проверяем специфическое сопоставление
      const mapping = ingredientMapping[ing];
      if(mapping){
        const { category, group, subgroup } = mapping;
        if(!toAdd[category]) toAdd[category] = { groups: {}, subgroups: {} };
        
        // Инициализируем группу, если её еще нет
        if(!toAdd[category].groups[group]){
          toAdd[category].groups[group] = [];
          if(!window.TAXONOMY.groups[category]){
            window.TAXONOMY.groups[category] = [];
          }
          if(!window.TAXONOMY.groups[category].includes(group)){
            window.TAXONOMY.groups[category].push(group);
          }
        }
        
        // Инициализируем подгруппу, если её еще нет
        if(!toAdd[category].subgroups[subgroup]){
          toAdd[category].subgroups[subgroup] = [];
          if(!window.TAXONOMY.subgroups[group]){
            window.TAXONOMY.subgroups[group] = [];
          }
          if(!window.TAXONOMY.subgroups[group].includes(subgroup)){
            window.TAXONOMY.subgroups[group].push(subgroup);
          }
        }
        
        // Добавляем ингредиент в подгруппу как наименование
        if(!window.TAXONOMY.names[subgroup]){
          window.TAXONOMY.names[subgroup] = [];
        }
        if(!window.TAXONOMY.names[subgroup].includes(ing)){
          window.TAXONOMY.names[subgroup].push(ing);
        }
      } else {
        // Общая логика классификации по ключевым словам
        const ingLower = ingCanon;
        
        if(ingLower.includes('рыба') || ingLower.includes('морепродукт') || ingLower.includes('белая')){
          // Добавляем в категорию Овощи -> Морепродукты
          const category = 'Овощи';
          const group = 'Морепродукты';
          const subgroup = 'Рыба';
          
          if(!window.TAXONOMY.groups[category]) window.TAXONOMY.groups[category] = [];
          if(!window.TAXONOMY.groups[category].includes(group)){
            window.TAXONOMY.groups[category].push(group);
          }
          if(!window.TAXONOMY.subgroups[group]){
            window.TAXONOMY.subgroups[group] = [];
          }
          if(!window.TAXONOMY.subgroups[group].includes(subgroup)){
            window.TAXONOMY.subgroups[group].push(subgroup);
          }
          if(!window.TAXONOMY.names[subgroup]){
            window.TAXONOMY.names[subgroup] = [];
          }
          if(!window.TAXONOMY.names[subgroup].includes(ing)){
            window.TAXONOMY.names[subgroup].push(ing);
          }
        } else if(ingLower.includes('дым') || ingLower.includes('кинин') || ingLower.includes('хмель') || ingLower.includes('перец') || ingLower.includes('уксус') || ingLower.includes('бальзамик')){
          // Добавляем в категорию Пряности
          const category = 'Пряности';
          let group = 'Добавки и ароматизаторы';
          let subgroup = 'Ароматизаторы';
          
          if(ingLower.includes('кинин') || ingLower.includes('хмель')){
            group = 'Горькие добавки';
            if(ingLower.includes('кинин')) subgroup = 'Кинин';
            else if(ingLower.includes('хмель')) subgroup = 'Хмель';
          } else if(ingLower.includes('дым')){
            group = 'Добавки и ароматизаторы';
            subgroup = 'Дым';
          }
          
          if(!window.TAXONOMY.groups[category]) window.TAXONOMY.groups[category] = [];
          if(!window.TAXONOMY.groups[category].includes(group)){
            window.TAXONOMY.groups[category].push(group);
          }
          if(!window.TAXONOMY.subgroups[group]){
            window.TAXONOMY.subgroups[group] = [];
          }
          if(!window.TAXONOMY.subgroups[group].includes(subgroup)){
            window.TAXONOMY.subgroups[group].push(subgroup);
          }
          if(!window.TAXONOMY.names[subgroup]){
            window.TAXONOMY.names[subgroup] = [];
          }
          if(!window.TAXONOMY.names[subgroup].includes(ing)){
            window.TAXONOMY.names[subgroup].push(ing);
          }
        }
      }
    }
  });
})();


/* ==== ДОБАВЛЕНО ChatGPT: молекулярная логика из The Flavor Matrix + терпеновые/тиоловые кластеры ==== */

/**
 * FLAVOR_CHEMISTRY — абстрактный слой над FLAVOR_DATA.
 * Здесь нет готовых рецептов, только «правила игры»:
 *  - как работают вкусы между собой (taste-модель);
 *  - какие крупные ароматические семейства существуют и как они дружат;
 *  - молекулярные кластеры (терпены, тиолы, норизопреноиды, пиразины, лизатные, эмпирематические).
 *
 * Использование:
 *  - FLAVOR_CHEMISTRY.tastes       → подсказки по балансировке вкуса;
 *  - FLAVOR_CHEMISTRY.aromaFamilies→ логика ароматических мостов;
 *  - FLAVOR_CHEMISTRY.moleculeFamilies → молекулярные связи;
 *  - findMolecularNeighbors(name)  → какие молекулярные кластеры связаны с продуктом;
 *  - getMolecularSuggestionGraph(name) → аналог, но ещё и список «соседей»-ингредиентов.
 */

window.FLAVOR_CHEMISTRY = {
  /* 1. ВКУСЫ (taste-level): что с чем дружит и что чем балансить */
  tastes: {
    sweet: {
      name: "Сладкий",
      complementary: ["sweet", "salty", "fat", "umami"],
      balancing: ["sour", "bitter", "spicy"],
      examples: ["мёд", "сахар", "спелые фрукты"]
    },
    sour: {
      name: "Кислый",
      complementary: ["salty", "spicy"],
      balancing: ["sweet", "fat"],
      examples: ["лимон", "уксус", "йогурт"]
    },
    salty: {
      name: "Солёный",
      complementary: ["sweet", "umami", "fat"],
      balancing: ["bitter"],
      examples: ["соль", "сыры", "соевый соус"]
    },
    bitter: {
      name: "Горький",
      complementary: ["bitter", "spicy"],
      balancing: ["sweet", "fat", "salty"],
      examples: ["тоник (кинин)", "хмель", "кофе"]
    },
    umami: {
      name: "Умами",
      complementary: ["salty", "fat", "sweet"],
      balancing: ["sour"],
      examples: ["пармезан", "томаты", "грибы", "анчоусы"]
    },
    fat: {
      name: "Жирный",
      complementary: ["sweet", "umami", "salty"],
      balancing: ["sour", "bitter", "spicy"],
      examples: ["сливки", "масло", "жирное мясо", "авокадо"]
    },
    spicy: {
      name: "Острый",
      complementary: ["sour", "salty"],
      balancing: ["fat", "sweet"],
      examples: ["чили", "имбирь", "перец"]
    }
  },

  /* 2. АРОМАТИЧЕСКИЕ СЕМЕЙСТВА (укрупнённый flavor-круг) */
  aromaFamilies: {
    fruity: {
      name: "Фруктовый",
      mainSubfamilies: ["berry", "citrus", "dried", "melon", "tree_fruit", "tropical"],
      typicalSources: [
        "Ягоды", "Цитрусовые", "Яблоки/Груши",
        "Косточковые", "Тропические фрукты", "Виноград белый", "Виноград красный"
      ],
      pairsWellWith: ["dairy", "maillard", "nutty", "spice", "floral"],
      notes: "Фруктовые ноты любят жир (сливки, масло), жареное/карамель, орехи и пряности."
    },
    phenol: {
      name: "Фенольный/дымный",
      mainSubfamilies: ["smoky", "chocolate", "dried"],
      typicalSources: ["Копчёности", "Копчёный чай", "Кофе тёмной обжарки", "Тёмное пиво"],
      pairsWellWith: ["fruity", "maillard", "meaty", "sour", "spice"],
      notes: "Дым и фенолы усиливают жареное/мясное, требуют кислоты или сладости для баланса."
    },
    pungent: {
      name: "Острый/резкий",
      mainSubfamilies: ["sulphur_pungent", "acidic_pungent"],
      typicalSources: ["Хрен", "Горчица", "Редис", "Чеснок", "Имбирь"],
      pairsWellWith: ["fat", "sweet", "fruity", "dairy"],
      notes: "Резкие ноты смягчаются жиром и сладостью; хорошо работают с фруктовой кислотой."
    },
    maillard: {
      name: "Maillard / жареный",
      mainSubfamilies: ["meaty", "nutty", "roasted", "toasted"],
      typicalSources: ["Жареное мясо", "Поджаренный хлеб", "Жареный лук", "Кофе", "Какао"],
      pairsWellWith: ["fruity", "dairy", "alcohol", "sour", "spice"],
      notes: "Всё жареное, тостовое и мясное. Любит фруктовую кислоту, алкоголь и молочные."
    },
    terpene: {
      name: "Терпены",
      mainSubfamilies: ["citrus", "herbal", "floral", "resinous", "spice"],
      typicalSources: ["Лимоны", "Лаймы", "Апельсины", "Грейпфруты", "Можжевельник", "Розмарин", "Базилик", "Тимьян", "Лаванда"],
      pairsWellWith: ["fruity", "floral", "sour", "alcohol", "dairy"],
      notes: "Терпены дают цитрусовые, хвойные, цветочные и пряные ноты. Это мост между цитрусом и зеленью."
    },
    marine: {
      name: "Морской",
      mainSubfamilies: ["briny", "iodine"],
      typicalSources: ["Устрицы", "Мидии", "Водоросли", "Рыба белая"],
      pairsWellWith: ["sour", "fruity", "terpene", "maillard"],
      notes: "Морские ноты просятся к лимону, травам и лёгкой обжарке."
    },
    sour: {
      name: "Кислый/ферментированный",
      mainSubfamilies: ["lactic", "acetic"],
      typicalSources: ["Йогурт", "Кефир", "Сметана", "Уксус", "Ферментированные овощи"],
      pairsWellWith: ["fat", "maillard", "fruity", "spicy"],
      notes: "Кислота чистит жир и освежает жареные ноты, усиливает фруктовость."
    },
    vegetal: {
      name: "Растительный",
      mainSubfamilies: ["earthy", "green", "herbaceous"],
      typicalSources: ["Свекла", "Морковь", "Сельдерей", "Зелень", "Капустные"],
      pairsWellWith: ["dairy", "maillard", "terpene", "nutty", "fruity"],
      notes: "Землистые и зелёные ноты любят молочные, орехи и жареные оттенки плюс немного фрукта/кислоты."
    },
    dairy: {
      name: "Молочный",
      mainSubfamilies: ["fresh", "aged"],
      typicalSources: ["Молоко", "Сливки", "Йогурт", "Сливочное масло", "Сыры"],
      pairsWellWith: ["fruity", "maillard", "terpene", "vegetal", "spice"],
      notes: "Жир и белок смягчают кислоту и горечь, связывают сложные ароматические композиции."
    },
    alcohol: {
      name: "Алкогольный",
      mainSubfamilies: ["wine", "fortified", "spirits"],
      typicalSources: ["Вино белое", "Вино красное", "Ром", "Бренди/Коньяк", "Виски"],
      pairsWellWith: ["maillard", "fruity", "dairy", "spice"],
      notes: "Алкоголь несёт аромат, поднимает фрукт и специи, подчёркивает жареное."
    },
    floral: {
      name: "Цветочный",
      mainSubfamilies: ["white_flower", "rose", "violet"],
      typicalSources: ["Лаванда", "Роза", "Цветок апельсина", "Личи", "Маракуйя"],
      pairsWellWith: ["fruity", "berry", "citrus", "dairy"],
      notes: "Цветочные ноты усиливаются ягодами, тропическими фруктами и мягкими молочными основами."
    }
  },

  /* 3. МОЛЕКУЛЯРНЫЕ КЛАСТЕРЫ ИЗ ТВОЕГО СПИСКА */
  moleculeFamilies: {
    terpenes: {
      name: "Терпены и их производные",
      profile: "Яркие цветочные, цитрусовые, хвойные и пряные ароматы. Очень летучие, дают ощущение свежести.",
      mainCompounds: {
        linalool: {
          name: "Линалоол",
          typicalSources: ["Лаванда", "Цветок апельсина", "Лилия", "Лавровый лист"],
          suggestedPairingLogic: "Соединяет цветочные травы с цитрусом и мягкими фруктами; мост для джинов, игристых и лёгких белых/розе."
        },
        geraniol: {
          name: "Гераниол",
          typicalSources: ["Роза", "Дикая морковь"],
          suggestedPairingLogic: "Работает с ягодами (малина, клубника), косточковыми и красными винами; любит лёгкую горчинку (вермуты, биттеры)."
        },
        nerol_citronellol: {
          name: "Нерол и цитронеллол",
          typicalSources: ["Розы", "Цитрусовая цедра", "Лемонграсс"],
          suggestedPairingLogic: "Дают ощущение цитрусового цвета; собирают вместе цитрусы, розу, вербену, тархун и большинство свежих белых вин."
        },
        limonene_citral: {
          name: "Лимонен и цитраль",
          typicalSources: ["Лимоны", "Лаймы", "Грейпфруты", "Бергамот", "Мандарины", "Тмин", "Укроп", "Фенхель", "Петрушка", "Лемонграсс"],
          suggestedPairingLogic: "Типичный «цитрусовый мост»: где есть кислота и свежесть (цитрус, травы, анисовые), можно смело миксовать между собой."
        },
        cineole_alpha_pinene: {
          name: "1,8-цинеол и α-пинен",
          typicalSources: ["Можжевельник", "Розмарин", "Эвкалипт"],
          suggestedPairingLogic: "Хвойно-камфорные. Переносят высокий алкоголь, отлично работают в крепких коктейлях и с жирным мясом/сыром."
        },
        rotundone: {
          name: "Ротундон (сесквитерпен)",
          typicalSources: ["Чёрный перец", "Тимьян", "Базилик"],
          suggestedPairingLogic: "Перечно-пряная нота. Любит танины, красные вина, жареное мясо и сладкие фрукты (груша, персик, клубника)."
        }
      }
    },

    thiols: {
      name: "Тиолы (тиоловые ароматические соединения)",
      profile: "Ультра-мощные молекулы с очень низким порогом восприятия. В малых дозах — маракуйя, крыжовник и грейпфрут; в больших — пот/кошачий лоток.",
      mainCompounds: {
        m4mp: {
          name: "4MMP (4-меркапто-4-метилпентан-2-он)",
          typicalSources: ["Самшит", "Маракуйя", "Ракитник", "Чёрная смородина"],
          suggestedPairingLogic: "Чёрная смородина + маракуйя + зелёные и цитрусовые вина (совиньон-блан); хорошо держит горечь тоника и сухие травы."
        },
        m3h: {
          name: "3MH (3-меркапто-гексан-1-ол)",
          typicalSources: ["Маракуйя", "Розовый грейпфрут", "Крыжовник", "Гуава"],
          suggestedPairingLogic: "Сшивает тропики (маракуйя/гуава) с розовым грейпфрутом и крыжовником; отлично в слабо-сладких хайболах и сауэрах."
        },
        m3ha: {
          name: "3MHA (3-меркапто-гексил-ацетат)",
          typicalSources: ["Маракуйя", "Розовый грейпфрут", "Самшит", "Крыжовник", "Гуава"],
          suggestedPairingLogic: "Эстерная версия 3MH — ещё более фруктовая и яркая. Просит кислоты и холода; не перегружать алкоголем, чтобы не уйти в «кошачий» профиль."
        }
      },
      concentrationNote: "Чем выше концентрация тиолов, тем меньше ощущается фрукт и тем больше пот/«кошачий лоток». В коктейлях и блюдах лучше работать с разбавлением и охлаждением."
    },

    norisoprenoids: {
      name: "Норизопреноиды",
      profile: "Производные каротиноидов, часто в ароматных и выдержанных винах. Даёт нефтяные, цветочные, фруктовые и древесные ноты.",
      mainCompounds: {
        tdn: {
          name: "TDN",
          typicalSources: ["Выдержанные рислинги", "Ароматные белые вина"],
          suggestedPairingLogic: "Нефтеподобная нота (бензин/керосин). Нужны яркие фрукты, лайм, персик/абрикос и немного соли/копчёности (копчёная рыба)."
        },
        beta_damascenone: {
          name: "β-дамасценон",
          typicalSources: ["Ароматные вина", "Яблоки", "Розы"],
          suggestedPairingLogic: "Очень мощный усилитель сладко-фруктового восприятия — «умами» для ароматов. Немного усиливает остальные ароматы."
        },
        vitispirane: {
          name: "Витиспиран",
          typicalSources: ["Выдержанные вина"],
          suggestedPairingLogic: "Соединяет цветочность, фрукт и дерево. Хорошо работает с бочковыми спиртами (коньяк, ром), косточковыми и пряностями."
        }
      }
    },

    pyrazines: {
      name: "Пиразины",
      profile: "Зелёный болгарский перец, свекольная ботва, спаржа, свежескошенная трава.",
      typicalSources: ["Зелёный болгарский перец", "Свекольная ботва", "Спаржа", "Крыжовник", "Свежая трава"],
      pairingLogic: "Зелёные пиразины любят цитрус, соль и жир: лимон/лайм + оливковое масло + зелень; в напитках — лайм, огурец, лёгкий джин/текила."
    },

    lysates: {
      name: "Лизатные/дрожжевые ноты",
      profile: "Хлебные, ореховые, дрожжевые — бриошь, тост, поджаренная корочка.",
      typicalSources: ["Хлеб", "Тост", "Шампанское на осадке", "Зрелые сыры", "Экстракт дрожжей"],
      pairingLogic: "Лизатные ноты — лучший друг умами и сладости: шампанское + пармезан, тосты + паштеты, дрожжевое пиво + орехи/карамель."
    },

    empyreumatic: {
      name: "Эмпирематические (жжёные, дымные)",
      profile: "Пепел, сажа, жжёное дерево, горелая смола, сильно обжаренный кофе.",
      typicalSources: ["Сильно обжаренный дуб", "Копчёности", "Жареные зёрна кофе", "Сильный карамельный сироп"],
      pairingLogic: "Очень мощный слой. Нужны жир, сладость и/или кислотность: сливки, карамель, фрукт, крепкий алкоголь. Нежные фрукты/травы лучше не перегружать."
    }
  }
};

/* УТИЛИТАРНЫЕ ХЭЛПЕРЫ: поиск по молекулярным кластерам */

/**
 * findMolecularNeighbors('Маракуйя') → список кластеров/соединений,
 * где маракуйя фигурирует как typicalSource.
 */
window.findMolecularNeighbors = function(ingredientName){
  const needle = normalizeString(ingredientName);
  const hits = [];
  if(!window.FLAVOR_CHEMISTRY || !window.FLAVOR_CHEMISTRY.moleculeFamilies) return hits;

  for(const [familyKey, family] of Object.entries(window.FLAVOR_CHEMISTRY.moleculeFamilies)){
    if(family.mainCompounds){
      for(const [compoundKey, compound] of Object.entries(family.mainCompounds)){
        const sources = (compound.typicalSources || []).map(normalizeString);
        if(sources.includes(needle)){
          hits.push({
            familyKey,
            familyName: family.name,
            compoundKey,
            compoundName: compound.name
          });
        }
      }
    }
    if(family.typicalSources){
      const sources = (family.typicalSources || []).map(normalizeString);
      if(sources.includes(needle)){
        hits.push({
          familyKey,
          familyName: family.name,
          compoundKey: null,
          compoundName: null
        });
      }
    }
  }
  return hits;
};

/**
 * getMolecularSuggestionGraph('Маракуйя') →
 *  {
 *    clusters: [... как в findMolecularNeighbors ...],
 *    relatedIngredients: ["Грейпфрут", "Крыжовник", ...]
 *  }
 *
 * Связывает продукт с другими типичными источниками внутри тех же молекулярных семейств.
 */
window.getMolecularSuggestionGraph = function(ingredientName){
  const needle = normalizeString(ingredientName);
  const clusters = window.findMolecularNeighbors(ingredientName);
  const related = new Set();

  if(!window.FLAVOR_CHEMISTRY || !window.FLAVOR_CHEMISTRY.moleculeFamilies) {
    return { clusters, relatedIngredients: [] };
  }

  for(const hit of clusters){
    const family = window.FLAVOR_CHEMISTRY.moleculeFamilies[hit.familyKey];
    if(!family) continue;

    if(hit.compoundKey && family.mainCompounds){
      const compound = family.mainCompounds[hit.compoundKey];
      if(compound && compound.typicalSources){
        compound.typicalSources.forEach(src => {
          if(normalizeString(src) !== needle){
            related.add(src);
          }
        });
      }
    } else {
      // кластеры без mainCompounds, только typicalSources на уровне семейства
      (family.typicalSources || []).forEach(src => {
        if(normalizeString(src) !== needle){
          related.add(src);
        }
      });
    }
  }

  return {
    clusters,
    relatedIngredients: Array.from(related)
  };
};




/* ==== ДОБАВЛЕНО ChatGPT: расширение FLAVOR_DATA по молекулярной логике ====
 *
 * Мы не перезаписываем существующие записи, а патчим их:
 *  - для ряда ингредиентов добавляются новые сочетания в best/good/unexpected;
 *  - добавления делаются только если пары (to) ещё нет в соответствующей категории.
 */

window.FLAVOR_DATA_ENRICH = {
  "Маракуйя": {
    "notes": "Тиолы (3MH, 3MHA). Тропический, крыжовниково-грейпфрутовый профиль.",
    "best": [
      {"to":"Розовый грейпфрут","tip":"Общая тиольная база + кислотность"},
      {"to":"Крыжовник","tip":"Зелёно-фруктовые тиольные ноты"},
      {"to":"Гуава","tip":"Усиление тропического профиля"},
      {"to":"Шампанское","tip":"Кислота и пузырь подчёркивают тиолы"}
    ],
    "good": [
      {"to":"Йогурт","tip":"Кисломолочная жирность смягчает резкость тиолов"},
      {"to":"Ром белый","tip":"Тростниковая сладость + тропический профиль"},
      {"to":"Лемонграсс","tip":"Цитраль подчеркивает тропический характер"}
    ],
    "unexpected": [
      {"to":"Базилик","tip":"Зелёные терпены поддерживают маракуйю"},
      {"to":"Чёрный перец","tip":"Ротундон добавляет перечно-пряный акцент"}
    ]
  },

  "Крыжовник": {
    "notes": "Яркая кислота, пиразины и тиолы. Переход между зелёными и тропическими фруктами.",
    "best": [
      {"to":"Маракуйя","tip":"Общие тиолы (3MH/3MHA) усиливают фруктовость"},
      {"to":"Розовый грейпфрут","tip":"Тиольный цитрус + кислая опора"},
      {"to":"Чёрная смородина","tip":"Связь по тиолам (4MMP) и зелёным тонам"},
      {"to":"Шампанское","tip":"Кислота и автолиз подчёркивают зелёные фрукты"}
    ],
    "good": [
      {"to":"Мята","tip":"Освежает и подчёркивает кислоту"},
      {"to":"Йогурт","tip":"Смягчает резкость, создаёт десертный профиль"}
    ],
    "unexpected": [
      {"to":"Базилик","tip":"Травяные терпены продолжают зелёный характер"},
      {"to":"Огурец","tip":"Чистая зелёная свежесть для алко-хайболов"}
    ]
  },

  "Чёрная смородина": {
    "notes": "Сильный тиольный профиль (4MMP). От ягодной сладости до «кошачьей» остроты при высокой концентрации.",
    "best": [
      {"to":"Маракуйя","tip":"Общий тиольный характер, тропический сдвиг"},
      {"to":"Крыжовник","tip":"Зелёно-ягодный мост"},
      {"to":"Шампанское","tip":"Кислота и дрожжевые ноты обрамляют смородину"},
      {"to":"Тёмный шоколад","tip":"Горечь и какао балансируют мощный аромат"}
    ],
    "good": [
      {"to":"Розовый грейпфрут","tip":"Цитрусовое тиольное эхо"},
      {"to":"Ром белый","tip":"Сладость и спирт вытягивают ягодный профиль"}
    ],
    "unexpected": [
      {"to":"Розмарин","tip":"Смолистые терпены подчёркивают чёрную смородину"},
      {"to":"Тимьян","tip":"Травяной фон + перечность (ротундон)"}
    ]
  },

  "Лаванда": {
    "notes": "Линалоол и другие терпены. Цветочность с лёгкой лекарственной нотой.",
    "best": [
      {"to":"Лимоны","tip":"Цитрусовый кислый контраст к цветочности"},
      {"to":"Мёд","tip":"Цветочный мёд усиливает линалоол"},
      {"to":"Йогурт","tip":"Мягкая кисломолочная база для десертов и коктейлей"}
    ],
    "good": [
      {"to":"Шампанское","tip":"Автолиз + цветочные ноты"},
      {"to":"Ром белый","tip":"Флоральный тропический акцент в сауэрах"}
    ],
    "unexpected": [
      {"to":"Огурец","tip":"Чистая зелёная свежесть против цветочности"},
      {"to":"Тимьян","tip":"Травяной, но тоже терпеновый мост"}
    ]
  },

  "Роза": {
    "notes": "Гераниол, β-дамасценон. Чистая цветочность с фруктовым подтоном.",
    "best": [
      {"to":"Малина","tip":"Классическая ягодно-розовая связка"},
      {"to":"Личи","tip":"Тропическая цветочность, общие мотивы"},
      {"to":"Яблоки","tip":"Фруктово-цветочный десертный профиль"}
    ],
    "good": [
      {"to":"Шампанское","tip":"Флоральный акцент в игристом"},
      {"to":"Йогурт","tip":"Лёгкая кисломолочная база для розовых десертов"}
    ],
    "unexpected": [
      {"to":"Чёрный перец","tip":"Перчёность подчёркивает цветочность"},
      {"to":"Базилик","tip":"Травы + роза в сложных миксах"}
    ]
  },

  "Можжевельник": {
    "notes": "α-пинен, 1,8-цинеол. Хвойность, лёгкая камфора. База джина.",
    "best": [
      {"to":"Лимоны","tip":"Классика джин-тоника: цитрус + хвоя"},
      {"to":"Лаймы","tip":"Более резкая, тропическая цитрусовость"},
      {"to":"Огурец","tip":"Чистая зелёная свежесть против хвои"}
    ],
    "good": [
      {"to":"Розмарин","tip":"Усиление хвойного профиля"},
      {"to":"Тимьян","tip":"Смолистые травы в той же палитре"}
    ],
    "unexpected": [
      {"to":"Чёрная смородина","tip":"Тиольная ягода поверх хвойного фона"},
      {"to":"Грейпфруты","tip":"Горько-цитрусовый акцент в длинных напитках"}
    ]
  },

  "Розмарин": {
    "notes": "Терпены (цинеол, пинен). Смолистый, хвойный, слегка камфорный профиль.",
    "best": [
      {"to":"Апельсины","tip":"Цитрусовая сладость + хвойная пряность"},
      {"to":"Лимоны","tip":"Кислая свежесть против смолистости"},
      {"to":"Ягнёнок","tip":"Классика кухни: жирное мясо + хвоя"}
    ],
    "good": [
      {"to":"Шампанское","tip":"Ароматическая веточка в игристом коктейле"},
      {"to":"Чёрный перец","tip":"Перечно-хвойный акцент"}
    ],
    "unexpected": [
      {"to":"Маракуйя","tip":"Тропики + хвойные терпены"},
      {"to":"Крыжовник","tip":"Зелёные кислые фрукты + травы"}
    ]
  },

  "Зелёный болгарский перец": {
    "notes": "Пиразины. Зелёный, травяной, иногда почти винный профиль (как в некоторых винах).",
    "best": [
      {"to":"Лаймы","tip":"Кислота и цитрус подчёркивают зелёные ноты"},
      {"to":"Кинза","tip":"Трава + трава, общий зелёный профиль"},
      {"to":"Оливковое масло","tip":"Жир округляет резкость пиразинов"}
    ],
    "good": [
      {"to":"Фета","tip":"Соль и жир для салатов и миксов"},
      {"to":"Йогурт","tip":"Соусы и дипы с яркой зеленью"}
    ],
    "unexpected": [
      {"to":"Шампанское","tip":"Кислота и пузырь поднимают зелёные ноты (как в некоторых винах)"},
      {"to":"Маракуйя","tip":"Зелёно-тропический мост через тиолы"}
    ]
  },

  "Шампанское": {
    "notes": "Кислота, автолиз (лизатные ноты), иногда тиольные и цитрусово-фруктовые оттенки.",
    "best": [
      {"to":"Устрицы","tip":"Классика: морской йод + кислотность и пузырь"},
      {"to":"Пармезан","tip":"Лизатные ноты на лизатных нотах"},
      {"to":"Чёрная смородина","tip":"Яркая ягода в кисло-игристой базе"}
    ],
    "good": [
      {"to":"Маракуйя","tip":"Тиолы + кислотность + газ"},
      {"to":"Крыжовник","tip":"Зелёный фруктовый акцент в бокале"}
    ],
    "unexpected": [
      {"to":"Копчёный лосось","tip":"Жир и дым против свежести и кислоты"},
      {"to":"Розмарин","tip":"Травяная ветка в игристых коктейлях"}
    ]
  },

  "Выдержанные рислинги": {
    "notes": "Норизопреноиды (TDN). Нефтеподобные ноты, лайм, персик, иногда мёд.",
    "best": [
      {"to":"Персик","tip":"Общий фруктово-цветочный профиль"},
      {"to":"Абрикос","tip":"Косточковые фрукты подчёркивают сладость аромата"},
      {"to":"Копчёная рыба","tip":"Дым и «нефть» по одну сторону, кислота по другую"}
    ],
    "good": [
      {"to":"Кислая капуста","tip":"Ферментированная кислота + минералка вина"},
      {"to":"Козий сыр","tip":"Кислый жир + ароматное белое"}
    ],
    "unexpected": [
      {"to":"Карри","tip":"Специи и норизопреноиды дают сложный восточный профиль"},
      {"to":"Копчёный чай","tip":"Дым/смола поддерживают TDN"}
    ]
  }
};

/* Патчинг существующего FLAVOR_DATA новыми связями 
 * Выполняется сразу после определения FLAVOR_DATA_ENRICH
 * Использует канонические имена для проверки дубликатов
 */
(function patchFlavorData(){
  if (!window.FLAVOR_DATA || !window.FLAVOR_DATA_ENRICH) return;
  
  Object.entries(window.FLAVOR_DATA_ENRICH).forEach(function([key, patch]){
    // Создаем запись, если её еще нет в базе (для новых ингредиентов)
    if (!window.FLAVOR_DATA[key]) {
      window.FLAVOR_DATA[key] = { notes: '', best: [], good: [], bad: [], unexpected: [] };
    }
    
    var base = window.FLAVOR_DATA[key];

    ["notes","best","good","bad","unexpected"].forEach(function(cat){
      if (cat === "notes" && patch.notes) {
        // Если в оригинале нет notes или она пустая — обновляем/дописываем
        if (!base.notes || base.notes.trim() === '') {
          base.notes = patch.notes;
        } else if (patch.notes && !base.notes.includes(patch.notes)) {
          // Добавляем новую информацию, если она не дублируется
          base.notes = base.notes + ' ' + patch.notes;
        }
        return;
      }
      if (!patch[cat]) return;
      if (!base[cat]) base[cat] = [];
      
      // Используем канонические имена для проверки дубликатов
      patch[cat].forEach(function(item){
        if (!item || !item.to) return;
        const itemCanon = normalizeString(item.to);
        // Проверяем дубликаты по каноническому имени
        var exists = base[cat].some(function(x){ 
          return x && x.to && normalizeString(x.to) === itemCanon; 
        });
        if (!exists) {
          base[cat].push(item);
        }
      });
    });
  });
})();

// После патчинга обновляем таксономию, чтобы новые ингредиенты попали в неё
// Вызываем autoExpandTaxonomy ещё раз для обновления
(function updateTaxonomyAfterEnrichment(){
  if (!window.FLAVOR_DATA || !window.TAXONOMY) return;
  const { allIngredients } = extractAllIngredients();
  
  const existingKeys = new Set();
  (window.TAXONOMY.categories || []).forEach(cat => existingKeys.add(cat));
  Object.keys(window.TAXONOMY.groups || {}).forEach(g => existingKeys.add(g));
  Object.keys(window.TAXONOMY.subgroups || {}).forEach(sg => existingKeys.add(sg));
  Object.keys(window.TAXONOMY.names || {}).forEach(n => existingKeys.add(n));
  Object.keys(window.FLAVOR_DATA || {}).forEach(k => existingKeys.add(k));
  
  // Добавляем новые ингредиенты в таксономию
  allIngredients.forEach(ing => {
    const ingCanon = normalizeString(ing);
    let found = false;
    existingKeys.forEach(key => {
      if(normalizeString(key) === ingCanon){
        found = true;
      }
    });
    
    if(!found && window.FLAVOR_DATA[ing]){
      // Ингредиент есть в FLAVOR_DATA, но нет в таксономии
      // Добавляем его в соответствующую категорию по логике классификации
      const ingLower = ingCanon;
      
      if(ingLower.includes('вино') || ingLower.includes('рислинг') || ingLower.includes('шампанское')){
        // Алкогольные напитки
        if(!window.TAXONOMY.groups['Крепкие алкогольные напитки']) {
          window.TAXONOMY.groups['Крепкие алкогольные напитки'] = [];
        }
        if(!window.TAXONOMY.groups['Крепкие алкогольные напитки'].includes('Вино')) {
          window.TAXONOMY.groups['Крепкие алкогольные напитки'].push('Вино');
        }
        if(!window.TAXONOMY.subgroups['Вино']) {
          window.TAXONOMY.subgroups['Вино'] = [];
        }
        if(!window.TAXONOMY.subgroups['Вино'].includes(ing)){
          window.TAXONOMY.subgroups['Вино'].push(ing);
        }
      } else if(ingLower.includes('рыба') || ingLower.includes('устриц') || ingLower.includes('лосос')){
        // Морепродукты
        if(!window.TAXONOMY.groups['Овощи']) window.TAXONOMY.groups['Овощи'] = [];
        if(!window.TAXONOMY.groups['Овощи'].includes('Морепродукты')){
          window.TAXONOMY.groups['Овощи'].push('Морепродукты');
        }
        if(!window.TAXONOMY.subgroups['Морепродукты']){
          window.TAXONOMY.subgroups['Морепродукты'] = [];
        }
        if(!window.TAXONOMY.subgroups['Морепродукты'].includes('Рыба')){
          window.TAXONOMY.subgroups['Морепродукты'].push('Рыба');
        }
        if(!window.TAXONOMY.names['Рыба']){
          window.TAXONOMY.names['Рыба'] = [];
        }
        if(!window.TAXONOMY.names['Рыба'].includes(ing)){
          window.TAXONOMY.names['Рыба'].push(ing);
        }
      } else if(ingLower.includes('лаванд') || ingLower.includes('роз') || ingLower.includes('можжевел')){
        // Травы и ароматические
        if(!window.TAXONOMY.groups['Травы и зелень']) window.TAXONOMY.groups['Травы и зелень'] = [];
        if(!window.TAXONOMY.groups['Травы и зелень'].includes('Свежие травы')){
          window.TAXONOMY.groups['Травы и зелень'].push('Свежие травы');
        }
        if(!window.TAXONOMY.subgroups['Свежие травы']){
          window.TAXONOMY.subgroups['Свежие травы'] = [];
        }
        if(!window.TAXONOMY.subgroups['Свежие травы'].includes(ing)){
          window.TAXONOMY.subgroups['Свежие травы'].push(ing);
        }
        if(!window.TAXONOMY.names[ing]){
          window.TAXONOMY.names[ing] = [ing];
        }
      } else if(ingLower.includes('крыжовник') || ingLower.includes('смородина') || ingLower.includes('гуав') || ingLower.includes('личи')){
        // Ягоды и фрукты
        if(!window.TAXONOMY.groups['Фрукты']) window.TAXONOMY.groups['Фрукты'] = [];
        if(!window.TAXONOMY.groups['Фрукты'].includes('Ягоды')){
          window.TAXONOMY.groups['Фрукты'].push('Ягоды');
        }
        if(!window.TAXONOMY.subgroups['Ягоды']){
          window.TAXONOMY.subgroups['Ягоды'] = [];
        }
        if(!window.TAXONOMY.subgroups['Ягоды'].includes(ing)){
          window.TAXONOMY.subgroups['Ягоды'].push(ing);
        }
        if(!window.TAXONOMY.names[ing]){
          window.TAXONOMY.names[ing] = [ing];
        }
      } else if(ingLower.includes('грейпфрут') || ingLower.includes('лемонграсс')){
        // Цитрусовые
        if(!window.TAXONOMY.groups['Фрукты']) window.TAXONOMY.groups['Фрукты'] = [];
        if(!window.TAXONOMY.groups['Фрукты'].includes('Цитрусовые')){
          window.TAXONOMY.groups['Фрукты'].push('Цитрусовые');
        }
        if(!window.TAXONOMY.subgroups['Цитрусовые']){
          window.TAXONOMY.subgroups['Цитрусовые'] = [];
        }
        if(!window.TAXONOMY.subgroups['Цитрусовые'].includes(ing)){
          window.TAXONOMY.subgroups['Цитрусовые'].push(ing);
        }
        if(!window.TAXONOMY.names[ing]){
          window.TAXONOMY.names[ing] = [ing];
        }
      } else if(ingLower.includes('перец') && ingLower.includes('болгарск')){
        // Овощи
        if(!window.TAXONOMY.groups['Овощи']) window.TAXONOMY.groups['Овощи'] = [];
        if(!window.TAXONOMY.groups['Овощи'].includes('Стеблевые')){
          window.TAXONOMY.groups['Овощи'].push('Стеблевые');
        }
        if(!window.TAXONOMY.subgroups['Стеблевые']){
          window.TAXONOMY.subgroups['Стеблевые'] = [];
        }
        if(!window.TAXONOMY.subgroups['Стеблевые'].includes(ing)){
          window.TAXONOMY.subgroups['Стеблевые'].push(ing);
        }
        if(!window.TAXONOMY.names[ing]){
          window.TAXONOMY.names[ing] = [ing];
        }
      }
    }
  });
})();

