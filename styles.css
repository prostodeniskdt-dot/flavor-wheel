:root{
  --bg:#0a0a0a; --panel:#101012; --text:#f2f2f2;
  --best:#2ecc71; --good:#f1c40f; --bad:#e74c3c; --unexpected:#00c2ff;
  --muted:#cfcfcf; --topbar-h:106px;
  --leaf-w:4.2; --trunk-w:7.6;
}
*{box-sizing:border-box}
html,body{height:100%}
/* Вертикальный скролл по умолчанию (важно на мобильных) */
body{margin:0;background:#0a0a0a; color:var(--text); font:500 16px/1.55 Inter,system-ui,sans-serif; overflow-y:auto; overflow-x:hidden}
.topbar{min-height:var(--topbar-h); display:grid; grid-template-columns: 1fr; grid-auto-rows:minmax(42px,auto); row-gap:8px; align-items:center; padding:12px 18px; background:#101012; border-bottom:1px solid #1c1c1f; box-shadow:0 2px 0 rgba(255,45,45,.25)}
.brand{font-weight:800; letter-spacing:.5px}
.badge{display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#0d0d0f; color:#ffb3b3; font-weight:800; font-size:12px}
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.taxo-row{justify-content:flex-start}
.field{display:flex; align-items:center; gap:8px}
.input,.select{background:#0d0d0f; color:var(--text); border:1px solid #2a2a2e; padding:10px 12px; border-radius:10px; outline:none}
.select{min-width:180px}
.search{width:240px}
.layout{min-height:calc(100vh - var(--topbar-h)); display:grid; grid-template-columns:320px 1fr; gap:16px; padding:16px}
.sidebar{display:flex; flex-direction:column; gap:16px; min-height:0}
.panel{background:#101012; border:1px solid #1a1a1a; border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.55); position:relative}
.legend{list-style:none; padding:0; margin:8px 0 0 0}
.legend.small li{margin:2px 0}
.legend li{display:flex; align-items:center; gap:10px; color:#cfcfcf}
.chip{display:inline-block; width:14px; height:8px; border-radius:3px}
.chip-best{background:var(--best)} .chip-good{background:var(--good)} .chip-bad{background:var(--bad)} .chip-unexpected{background:var(--unexpected)}

.canvas-wrap{
  min-height:0;
  background:
    radial-gradient(560px 320px at 50% 58%, rgba(180,0,0,.40), transparent 62%),
    radial-gradient(980px 560px at 50% 60%, rgba(120,0,0,.22), transparent 66%),
    #0b0b0c;
  border:1px solid #0b0b0c; border-radius:16px; overflow:visible;
  box-shadow:0 10px 30px rgba(0,0,0,.55); position:relative; display:block
}
.zoom-ui{position:absolute; right:12px; top:12px; display:flex; gap:6px; z-index:5}
.zbtn{background:#0d0d0f; border:1px solid #2a2a2a; color:#fff; font-weight:800; padding:6px 10px; border-radius:10px; cursor:pointer}
.zbtn:hover{filter:brightness(1.1)}

.canvas{width:100%; height:100%}
.center-label{font-weight:900; font-size:15px; letter-spacing:.2px; color:#fff; background:#0d0d0f; border:2px solid #fff; padding:6px 12px; border-radius:999px; box-shadow:0 12px 30px rgba(0,0,0,.55); position:absolute; transform:translate(-50%,-50%); pointer-events:none}
.node text{fill:#eeeeee; text-anchor:start; dominant-baseline:middle; paint-order:stroke; stroke:#000; stroke-width:2px; opacity:0; transition:opacity .06s ease .01s}
.node.show text{opacity:1}
.link{fill:none; stroke-linecap:round; transition:filter .12s ease, stroke-width .12s ease, opacity .12s ease; opacity:0}
.link.anim-start{opacity:1}
.link-leaf{stroke-width:var(--leaf-w)} .link-trunk{stroke-width:var(--trunk-w)}
.link:hover{filter:brightness(1.2)}
.link-best{stroke:var(--best)} .link-good{stroke:var(--good)} .link-bad{stroke:var(--bad)} .link-unexpected{stroke:var(--unexpected)}
.dim{opacity:.28}
.is-highlight{stroke-width:calc(var(--leaf-w) + 1.6)}
.is-highlight-trunk{stroke-width:calc(var(--trunk-w) + 1.8)}
.endpoint{fill:currentColor; opacity:0; transition:opacity .08s ease .02s}
.endpoint.show{opacity:1}
.endpoint-best{color:var(--best)} .endpoint-good{color:var(--good)} .endpoint-bad{color:var(--bad)} .endpoint-unexpected{color:var(--unexpected)}
.dot-halo{opacity:.6; filter:url(#dot-glow)}
.callout{display:none}
.blob{filter:blur(26px); opacity:.12}
.blob-best{fill:#2ecc71} .blob-good{fill:#f1c40f} .blob-bad{fill:#e74c3c} .blob-unexpected{fill:#00c2ff}
.stamp circle{fill:#0d0d0f; stroke:#fff; stroke-width:1.6; filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))}
.stamp text{fill:#fff; font-weight:800; font-size:12px; text-anchor:middle; dominant-baseline:middle}
.notes{white-space:pre-wrap}
.err{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#1a1a1a; border:1px solid #a33; color:#ffb3b3; padding:10px 14px; border-radius:10px; font:600 14px/1.4 Inter,system-ui; box-shadow:0 10px 30px rgba(0,0,0,.5)}
.tooltip{display:none}

/* Desktop defaults */
.canvas-wrap{height:calc(100vh - var(--topbar-h) - 20px)}

.tg-btn{position:fixed; left:16px; bottom:16px; z-index:50; text-decoration:none; color:#fff; background:rgba(255,0,0,.08); border:1px solid rgba(255,80,80,.6); padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.5); backdrop-filter: blur(2px); font-weight:800; line-height:1.1}
.tg-btn span{font-weight:700; color:#ffb3b3}
.tg-btn:hover{background:rgba(255,0,0,.15)}

/* Mobile / Tablet */
@media (max-width: 1080px){
  .select{min-width:160px}
}
@media (max-width: 960px){
  :root{ --topbar-h:138px; }
  .layout{grid-template-columns:1fr; gap:12px; padding:12px}
  /* В мобильной версии контейнер растягиваемый + прокрутка */
  .canvas-wrap{
    height:auto; min-height:640px; max-height:none;
    overflow:auto; -webkit-overflow-scrolling:touch;
  }
  /* Даем svg гибкую высоту и aspect */
  .canvas{
    width:100%;
    height:auto;
    aspect-ratio: 16 / 10;
    min-height:560px;
  }
  .panel{padding:12px}
  .center-label{font-size:14px; padding:6px 10px}
  :root{ --leaf-w:3.8; --trunk-w:6.6; }
}
@media (max-width: 720px){
  .select{min-width:46vw}
  .search{width:52vw}
  .canvas-wrap{min-height:620px}
  .canvas{min-height:520px}
}
@media (max-width: 560px){
  body{font-size:14px}
  .controls{gap:6px}
  .input,.select{padding:8px 10px}
  .canvas-wrap{min-height:600px}
  .canvas{min-height:500px}
  .center-label{font-size:13px}
  :root{ --leaf-w:3.3; --trunk-w:5.8; }
}
